<app-buscador (buscar)="filtrar($event)"></app-buscador>

<div class="training-root">
  <div class="tabs" role="tablist" aria-label="Training tabs">
    <button role="tab" aria-selected="{{activeTab==='all'}}" class="tab" [class.active]="activeTab==='all'" (click)="setTab('all')">{{ 'TRAINING.TABS.ALL' | translate }}</button>
    <button role="tab" aria-selected="{{activeTab==='paths'}}" class="tab" [class.active]="activeTab==='paths'" (click)="setTab('paths')">{{ 'TRAINING.TABS.PATHS' | translate }}</button>
  </div>
  <div class="training-body">
    <div class="left" *ngIf="isTab('paths')">
    <div class="left-header">
      <h2>{{ 'TRAINING.TITLE' | translate }}</h2>
      <button class="jenkins-add-btn" (click)="newPath()">
        <mat-icon inline="true">add</mat-icon>
        <span>{{ 'TRAINING.NEW_PATH' | translate }}</span>
      </button>
    </div>

    <ul class="paths-list">
      <li *ngFor="let p of filteredPaths" (click)="selectPath(p)" [class.selected]="selectedPath?.id===p.id">
        <strong>{{ p.name }}</strong>
        <div class="meta">{{ p.audience }}</div>
        <div class="actions">
          <button type="button" class="icon-btn view" title="{{ 'TRAINING.VIEW' | translate }}" (click)="selectPath(p); $event.stopPropagation()"><span class="icon-eye">üëÅÔ∏è</span></button>
          <button type="button" class="icon-btn edit" title="{{ 'TRAINING.EDIT' | translate }}" (click)="editPath(p); $event.stopPropagation()"><span class="icon-edit">‚úèÔ∏è</span></button>
          <button type="button" class="icon-btn delete" title="{{ 'TRAINING.DELETE' | translate }}" (click)="confirmDeletePath(p.id, p.name); $event.stopPropagation()"><span class="icon-delete">üóëÔ∏è</span></button>
        </div>
      </li>
    </ul>
  </div>

  <div class="right" *ngIf="isTab('paths')">
    <div *ngIf="selectedPath; else noSelection">
      <div class="path-header">
        <h3>{{ selectedPath.name }}</h3>
        <button class="jenkins-add-btn csv-btn-small" (click)="exportPathToCsv()" title="{{ 'TRAINING.EXPORT' | translate }}">
          <mat-icon inline="true" style="font-size: 16px; width: 16px; height: 16px;">download</mat-icon>
          <span>CSV</span>
        </button>
      </div>
      <div class="path-meta">
        <div><strong>{{ 'TRAINING.AUDIENCE' | translate }}:</strong> {{ selectedPath.audience }}</div>
        <div><strong>{{ 'TRAINING.OBJECTIVES' | translate }}:</strong> {{ selectedPath.objectives }}</div>
        <div><strong>{{ 'TRAINING.PREREQUISITES' | translate }}:</strong> {{ selectedPath.prerequisites }}</div>
      </div>

      <div class="items-header">
        <h4>{{ 'TRAINING.ITEMS' | translate }}</h4>
        <button class="jenkins-add-btn" (click)="addItem()">
          <mat-icon inline="true">add</mat-icon>
          <span>{{ 'TRAINING.ADD_ITEM' | translate }}</span>
        </button>
      </div>

      <ul class="items-list" cdkDropList (cdkDropListDropped)="dropItem($event)" *ngIf="selectedPath">
        <li *ngFor="let it of selectedPath.items; let i = index" cdkDrag>
          <div class="item-main" (click)="openCourseLink(it)">
            <div class="item-number">{{ i + 1 }}</div>
            <div class="item-content">
              <strong>{{ it.name }}</strong>
              <div class="item-desc">{{ it.description }}</div>
              <div class="item-tags">{{ it.tags?.join(', ') }}</div>
            </div>
            <div class="item-actions">
              <button type="button" class="icon-btn view" title="{{ 'TRAINING.VIEW' | translate }}" (click)="viewCourse(it); $event.stopPropagation()"><span class="icon-eye">üëÅÔ∏è</span></button>
              <button type="button" class="icon-btn edit" title="{{ 'TRAINING.EDIT' | translate }}" (click)="editItem(it); $event.stopPropagation()"><span class="icon-edit">‚úèÔ∏è</span></button>
              <button type="button" class="icon-btn delete" title="{{ 'TRAINING.DELETE' | translate }}" (click)="confirmDeleteItem(it.id, it.name); $event.stopPropagation()"><span class="icon-delete">üóëÔ∏è</span></button>
            </div>
          </div>

          
        </li>
      </ul>
      <!-- Course selector modal (moved fuera del ngFor para que est√© disponible aunque no haya items) -->
      <div class="modal-backdrop" *ngIf="showCourseSelector">
        <div class="modal" (click)="$event.stopPropagation()">
          <h3>{{ 'TRAINING.SELECT_COURSE' | translate }}</h3>
          <app-buscador (buscar)="filterSelector($event)"></app-buscador>
          <div style="max-height:300px; overflow:auto; margin-top:10px">
            <ul class="paths-list">
              <li *ngFor="let c of selectorFilteredCandidates" [class.selected]="selectedCandidate?.id===c.id" (click)="selectCourse(c)">
                <strong>{{ c.name }}</strong>
                <div class="meta">{{ c.description }}</div>
              </li>
            </ul>
          </div>
          <div class="modal-actions">
            <button type="button" class="cancelar-btn" (click)="showCourseSelector=false" title="{{ 'TRAINING.CANCEL' | translate }}">‚úñÔ∏è</button>
            <button type="button" class="guardar-btn" (click)="confirmAddSelectedCourse()" [disabled]="!selectedCandidate" title="{{ 'TRAINING.ADD_ITEM' | translate }}">‚úîÔ∏è</button>
          </div>
        </div>
      </div>
                </div>
                <ng-template #noSelection>
                  <div class="no-selection">{{ 'TRAINING.NO_SELECTION' | translate }}</div>
                </ng-template>
              </div>

              <!-- All courses full-width panel -->
              <div class="all-courses" *ngIf="isTab('all')">
                <div class="left" style="width:100%">
                  <div class="left-header">
                    <h2>{{ 'TRAINING.ALL_COURSES' | translate }}</h2>
                    <div>
                      <button type="button" class="jenkins-add-btn" (click)="addCourseFromAll()">
                        <mat-icon inline="true">add</mat-icon>
                        <span>{{ 'TRAINING.NEW_COURSE' | translate }}</span>
                      </button>
                    </div>
                  </div>

                  <ul class="paths-list">
                    <li *ngFor="let c of filteredAllCourses; let i = index">
                          <div class="course-card">
                            <div class="course-content" (click)="openCourseLink(c)">
                              <strong>{{ c.name }}</strong>
                              <div class="meta">{{ c.description }}</div>
                              <div class="meta">{{ (c.tags||[]).join(', ') }}</div>
                            </div>
                            <div class="course-actions">
                              <button class="icon-btn view" title="{{ 'TRAINING.VIEW' | translate }}" (click)="viewCourse(c); $event.stopPropagation()"><span class="icon-eye">üëÅÔ∏è</span></button>
                              <button class="icon-btn edit" title="{{ 'TRAINING.EDIT' | translate }}" (click)="editCourse(c); $event.stopPropagation()"><span class="icon-edit">‚úèÔ∏è</span></button>
                              <button class="icon-btn delete" title="{{ 'TRAINING.DELETE' | translate }}" (click)="confirmDeleteCourse(c.id, c.name); $event.stopPropagation()"><span class="icon-delete">üóëÔ∏è</span></button>
                            </div>
                          </div>
                    </li>
                  </ul>
                </div>
              </div>
            </div>
          </div>

          <!-- Path modal -->
          <div class="modal-backdrop" *ngIf="showPathModal">
            <div class="modal" (click)="$event.stopPropagation()">
              <h3 *ngIf="!editingPath.readonly">{{ editingPath.id ? ('TRAINING.EDIT_PATH'|translate) : ('TRAINING.NEW_PATH'|translate) }}</h3>
              <h3 *ngIf="editingPath.readonly">{{ 'TRAINING.VIEW' | translate }}</h3>
              <div class="form-row"><label>{{ 'TRAINING.NAME' | translate }}</label><input [(ngModel)]="editingPath.name" [readonly]="editingPath.readonly" /></div>
              <div class="form-row"><label>{{ 'TRAINING.AUDIENCE' | translate }}</label><input [(ngModel)]="editingPath.audience" [readonly]="editingPath.readonly" /></div>
              <div class="form-row"><label>{{ 'TRAINING.OBJECTIVES' | translate }}</label><textarea rows="3" [(ngModel)]="editingPath.objectives" [readonly]="editingPath.readonly"></textarea></div>
              <div class="form-row"><label>{{ 'TRAINING.PREREQUISITES' | translate }}</label><input [(ngModel)]="editingPath.prerequisites" [readonly]="editingPath.readonly" /></div>
              <div class="modal-actions" *ngIf="!editingPath.readonly">
                <button type="button" class="guardar-btn" (click)="savePath()" title="{{ 'TRAINING.SAVE' | translate }}">‚úì</button>
                <button type="button" class="cancelar-btn" (click)="showPathModal=false" title="{{ 'TRAINING.CANCEL' | translate }}">‚úó</button>
              </div>
              <div class="modal-actions" *ngIf="editingPath.readonly"><button type="button" class="cancelar-btn" (click)="editingPath.readonly=false; showPathModal=false" title="{{ 'TRAINING.BACK' | translate }}">‚úñÔ∏è</button></div>
            </div>
          </div>

          <!-- Item modal -->
          <div class="modal-backdrop" *ngIf="showItemModal">
            <div class="modal" (click)="$event.stopPropagation()">
              <h3 *ngIf="!editingItem.readonly">{{ editingItem.id ? ('TRAINING.EDIT_ITEM'|translate) : ('TRAINING.NEW_ITEM'|translate) }}</h3>
              <h3 *ngIf="editingItem.readonly">{{ 'TRAINING.VIEW' | translate }}</h3>
              <div class="form-row"><label>{{ 'TRAINING.ITEM_NAME' | translate }}</label><input [(ngModel)]="editingItem.name" [readonly]="editingItem.readonly" /></div>
              <div class="form-row"><label>{{ 'TRAINING.ITEM_LINK' | translate }}</label>
                <div style="display:flex;gap:8px;align-items:center">
                  <input style="flex:1" [(ngModel)]="editingItem.link" [readonly]="editingItem.readonly" />
                  <button type="button" class="jenkins-add-btn csv-btn-small" title="{{ 'TRAINING.COPY' | translate }}" (click)="copyToClipboard(editingItem.link); $event.stopPropagation()" [disabled]="!(editingItem.link && (editingItem.link+'').trim())">
                    <mat-icon inline="true" style="font-size: 16px; width: 16px; height: 16px;">content_copy</mat-icon>
                    <span>{{ 'TRAINING.COPY' | translate }}</span>
                  </button>
                </div>
              </div>
              <div class="form-row"><label>{{ 'TRAINING.ITEM_DESC' | translate }}</label><textarea rows="3" [(ngModel)]="editingItem.description" [readonly]="editingItem.readonly"></textarea></div>
              <div class="form-row"><label>{{ 'TRAINING.ITEM_TAGS' | translate }}</label><input placeholder="Java,Spring" [(ngModel)]="editingItem.tagsString" [readonly]="editingItem.readonly" /></div>
              <div class="modal-actions" *ngIf="!editingItem.readonly">
                <button type="button" class="guardar-btn" (click)="saveItem()" title="{{ 'TRAINING.SAVE' | translate }}">‚úì</button>
                <button type="button" class="cancelar-btn" (click)="showItemModal=false" title="{{ 'TRAINING.CANCEL' | translate }}">‚úó</button>
              </div>
              <div class="modal-actions" *ngIf="editingItem.readonly">
                <button type="button" class="cancelar-btn" (click)="closeView()" title="{{ 'TRAINING.BACK' | translate }}">‚úó</button>
              </div>
            </div>
          </div>
 
            <!-- Confirmation modal -->
            <div class="modal-backdrop" *ngIf="showConfirm">
              <div class="modal" (click)="$event.stopPropagation()">
                <h3>{{ 'TRAINING.DELETE' | translate }}</h3>
                <div class="modal-body">{{ confirmMessage }}</div>
                <div class="modal-actions">
                  <button class="cancelar-btn" (click)="confirmCancel()" title="{{ 'TRAINING.CANCEL' | translate }}">‚úñÔ∏è</button>
                  <button class="guardar-btn" (click)="confirmOk()" title="Confirmar">‚úîÔ∏è</button>
                </div>
              </div>

              <!-- Toast -->
              <div class="toast" *ngIf="toastVisible">
                <div>{{ toastMessagePrefix }} <span class="toast-link">{{ toastMessage }}</span></div>
              </div>
            </div>
