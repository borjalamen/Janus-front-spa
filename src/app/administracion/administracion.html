<div class="section-container admin-layout">
  
  <div class="admin-sidebar">
    <h2 class="sidebar-title">Admin Panel</h2>
    
    <button class="menu-btn" 
            [class.active]="activeTab === 'USERS'" 
            (click)="cambiarTab('USERS')">
      <span class="menu-emoji">ğŸ‘¥</span> Usuarios
    </button>
    
    <button class="menu-btn" 
            [class.active]="activeTab === 'APP'" 
            (click)="cambiarTab('APP')">
      <span class="menu-emoji">âš™ï¸</span> AplicaciÃ³n
    </button>
    
    <button class="menu-btn" 
            [class.active]="activeTab === 'PARAM'" 
            (click)="cambiarTab('PARAM')">
      <span class="menu-emoji">ğŸ›ï¸</span> ParametrizaciÃ³n
    </button>
    
    <button class="menu-btn" 
            [class.active]="activeTab === 'DB'" 
            (click)="cambiarTab('DB')">
      <span class="menu-emoji">ğŸ—„ï¸</span> BBDD
    </button>
  </div>

  <div class="admin-content">

    <div *ngIf="activeTab === 'USERS'" class="tab-content fade-in">
      <div class="documents-header">
        <h2>Administrar Usuarios</h2>
        <button class="jenkins-add-btn" *ngIf="canEdit" (click)="obrirPopupCrear()">
          <mat-icon>add</mat-icon> AÃ±adir usuario
        </button>
      </div>

      <app-buscador (buscar)="filtrar($event)" style="margin-bottom: 20px; display: block;"></app-buscador>

      <div class="users-list">
        <div *ngFor="let usuari of usuarisFiltrats" class="usuari-item">
          <div>
            <div class="usuari-nom">
              <b>{{ usuari.fullName }}</b>
              <span class="usuari-rol">({{ usuari.roles.join(', ') }})</span>
            </div>
            <div class="usuari-email">{{ usuari.email }}</div>
          </div>

          <div class="actions">
            <button class="icon-btn view-profile" (click)="verPerfil(usuari)" title="Ver perfil completo">
              <span class="emoji-icon">ğŸ‘ï¸</span>
            </button>
            <button class="icon-btn edit" *ngIf="canEdit" (click)="obrirPopupEditar(usuari)" title="Actualizar usuario">
              <span class="emoji-icon">âœï¸</span>
            </button>
            <button class="icon-btn delete" *ngIf="canEdit" (click)="confirmarInhabilitar(usuari)" title="Inhabilitar usuario">
              <span class="emoji-icon">ğŸ—‘ï¸</span>
            </button>
          </div>
        </div>
      </div>
    </div>

    <div *ngIf="activeTab === 'APP'" class="tab-content fade-in">
      <div class="documents-header">
        <h2>Administrar AplicaciÃ³n</h2>
      </div>
      
      <div class="admin-card">
        <h3>Inhabilitar por roles</h3>
        <p>Seleccione un rol para restringir el acceso temporalmente a la aplicaciÃ³n.</p>
        
        <div class="form-field">
            <label>Seleccionar Rol:</label>
            <select [(ngModel)]="selectedRoleToDisable" class="custom-select">
                <option value="" disabled selected>-- Elegir --</option>
                <option value="CONSULTOR">Consultor</option>
                <option value="DEV">DevOps</option>
            </select>
        </div>
        
        <div style="margin-top: 16px; text-align: right;">
            <button class="jenkins-add-btn" (click)="inhabilitarPorRol()">
                Inhabilitar Acceso
            </button>
        </div>
      </div>
    </div>

    <div *ngIf="activeTab === 'PARAM'" class="tab-content fade-in">
      <div class="documents-header">
        <h2>ParametrizaciÃ³n</h2>
      </div>

      <div class="admin-card">
        <h3>Cambio de versiÃ³n</h3>
        <p>GestiÃ³n de la versiÃ³n actual del despliegue.</p>
        
        <div class="form-field">
            <label>VersiÃ³n del Sistema:</label>
            <input type="text" [(ngModel)]="appVersion" placeholder="Ej: 1.0.0">
        </div>

        <div style="margin-top: 16px; text-align: right;">
            <button class="jenkins-add-btn" (click)="cambiarVersion()">
                <mat-icon>update</mat-icon> Actualizar VersiÃ³n
            </button>
        </div>
      </div>
    </div>

    <div *ngIf="activeTab === 'DB'" class="tab-content fade-in">
      <div class="documents-header">
        <h2>AdministraciÃ³n de la BBDD</h2>
      </div>

      <div class="db-grid">
        <div class="admin-card db-card">
            <span class="big-emoji warn">ğŸ—‘ï¸</span>
            <h3>Borrado FÃ­sico</h3>
            <p>Elimina permanentemente registros marcados.</p>
            <button class="popup-btn" (click)="accionBBDD('borrado')">Seleccionar y Ejecutar</button>
        </div>

        <div class="admin-card db-card">
            <span class="big-emoji">ğŸ”„</span>
            <h3>Restore</h3>
            <p>Restaura la base de datos a un punto anterior.</p>
            <button class="popup-btn" (click)="accionBBDD('restore')">Elegir VersiÃ³n</button>
        </div>

        <div class="admin-card db-card">
            <span class="big-emoji">ğŸ’¾</span>
            <h3>Backup</h3>
            <p>Genera una copia de seguridad actual.</p>
            <button class="popup-btn" (click)="accionBBDD('backup')">Seleccionar y Generar</button>
        </div>
      </div>
    </div>

  </div>
</div>
<div class="modal-overlay" *ngIf="mostrarPopup">
  <div class="auth-card">
    <h2 class="form-title">{{ usuariEditant ? 'Modificar Usuario' : 'Nuevo Usuario' }}</h2>
    <hr class="divider">

    <div class="form-content">
      <div class="input-field">
        <label>Nombre</label>
        <input type="text" [(ngModel)]="nouUsuari.nombre" placeholder="jlopez">
      </div>

      <div class="input-field">
        <label>Email</label>
        <input type="email" [(ngModel)]="nouUsuari.email" placeholder="jlopez@minsait.com">
      </div>

      <div class="input-field">
        <label>ContraseÃ±a</label>
        <input type="password" [(ngModel)]="nouUsuari.contrasenya" placeholder="{{ usuariEditant ? 'Dejar vacÃ­o para mantener' : 'Introduce contraseÃ±a' }}">
      </div>

      <hr class="divider">

      <label class="section-label">Roles del Usuario:</label>
      
      <div class="roles-grid">
        <div class="switch-item">
          <label class="custom-switch">
            <input type="checkbox" [(ngModel)]="nouUsuari.rols.admin">
            <span class="custom-slider"></span>
          </label>
          <span class="role-text">Administrador</span>
        </div>

        <div class="switch-item">
          <label class="custom-switch">
            <input type="checkbox" [(ngModel)]="nouUsuari.rols.consultor">
            <span class="custom-slider"></span>
          </label>
          <span class="role-text">Consultor</span>
        </div>

        <div class="switch-item">
          <label class="custom-switch">
            <input type="checkbox" [(ngModel)]="nouUsuari.rols.devops">
            <span class="custom-slider"></span>
          </label>
          <span class="role-text">DevOps</span>
        </div>
      </div>

      <hr class="divider">

      <div class="action-buttons">
        <button class="btn-emoji cancel" (click)="tancarPopup()" title="Cancelar">âœ—</button>
        <button class="btn-emoji confirm" (click)="guardarUsuari()" title="Guardar">âœ“</button>
      </div>
    </div>
  </div>
</div>

<!-- Popup confirmaciÃ³n eliminar usuario -->
<div class="modal-overlay" *ngIf="mostrarPopupDelete">
  <div class="auth-card">
    <h2 class="form-title">Eliminar Usuario</h2>
    <hr class="divider">
    <div class="form-content">
      <p>Â¿EstÃ¡s seguro de que quieres eliminar al usuario <strong>{{ usuariAEsborrar?.fullName }}</strong>?</p>
      <p style="color: #ff6b6b; font-size: 0.9em;">Esta acciÃ³n no se puede deshacer.</p>
      <hr class="divider">
      <div class="action-buttons">
        <button class="btn-emoji cancel" (click)="cancelarInhabilitar()" title="Cancelar">âœ—</button>
        <button class="btn-emoji confirm" (click)="inhabilitarUsuari()" title="Eliminar">âœ“</button>
      </div>
    </div>
  </div>
</div>

<!-- Popup Borrado FÃ­sico -->
<div class="modal-overlay" *ngIf="mostrarPopupBorrado">
  <div class="auth-card db-popup db-popup-large">
    <h2 class="form-title">
      <span class="title-emoji">ğŸ—‘ï¸</span>
      Borrado FÃ­sico
    </h2>
    <hr class="divider">
    <div class="form-content">
      
      <!-- BÃºsqueda de colecciÃ³n -->
      <div class="borrado-section">
        <h4>ğŸ“‚ Buscar ColecciÃ³n</h4>
        <p>Busca una colecciÃ³n para ver y eliminar sus registros <strong>inactivos</strong>:</p>
        
        <div class="collection-search">
          <div class="input-field">
            <label>Nombre de la colecciÃ³n:</label>
            <input type="text" 
                   [(ngModel)]="coleccionBorrar" 
                   placeholder="Ej: usuarios, documentos, logs, sesiones"
                   class="collection-input"
                   (keyup.enter)="buscarColeccion()">
          </div>
          <button class="btn-round btn-search" (click)="buscarColeccion()" [disabled]="!coleccionBorrar || cargandoRegistrosInactivos">
            <span *ngIf="!cargandoRegistrosInactivos">ğŸ” Buscar</span>
            <span *ngIf="cargandoRegistrosInactivos">â³ Cargando...</span>
          </button>
        </div>

        <!-- ColecciÃ³n no encontrada -->
        <div *ngIf="coleccionNoEncontrada" class="collection-not-found">
          <p>âŒ No se encontrÃ³ la colecciÃ³n "{{ coleccionBorrar }}"</p>
        </div>

        <!-- ColecciÃ³n encontrada con registros inactivos -->
        <div *ngIf="coleccionEncontrada" class="collection-found-detail">
          <div class="collection-header">
            <div class="collection-info">
              <p>âœ… ColecciÃ³n: <strong>{{ coleccionBorrar }}</strong></p>
              <p class="stats">ğŸ“Š Total: {{ registrosColeccion }} registros | ğŸš« Inactivos: <strong>{{ registrosInactivos }}</strong></p>
            </div>
            <button class="btn-round btn-secondary btn-sm" (click)="limpiarBusquedaColeccion()">
              âœ• Limpiar
            </button>
          </div>

          <!-- Lista de registros inactivos -->
          <div *ngIf="registrosInactivosColeccion.length > 0" class="registros-inactivos-list">
            <div class="seleccionar-todos">
              <label class="custom-checkbox">
                <input type="checkbox" 
                       [checked]="registrosSeleccionadosBorrar.size === registrosInactivosColeccion.length && registrosInactivosColeccion.length > 0"
                       (change)="seleccionarTodosRegistros()">
                <span class="checkmark"></span>
                <span>Seleccionar todos ({{ registrosInactivosColeccion.length }})</span>
              </label>
            </div>
            
            <div class="registros-scroll">
              <div *ngFor="let registro of registrosInactivosColeccion" class="registro-inactivo-item">
                <label class="custom-checkbox">
                  <input type="checkbox" 
                         [checked]="registrosSeleccionadosBorrar.has(registro.id)"
                         (change)="toggleSeleccionRegistro(registro.id)">
                  <span class="checkmark"></span>
                  <div class="registro-info">
                    <div class="registro-header">
                      <span class="registro-id">{{ registro.id }}</span>
                      <span class="registro-fecha">ğŸ“… {{ registro.fechaInactivacion }}</span>
                    </div>
                    <span class="registro-nombre">{{ registro.nombre }}</span>
                    <span class="registro-descripcion">{{ registro.descripcion }}</span>
                  </div>
                </label>
              </div>
            </div>
            
            <div class="borrar-registros-actions" *ngIf="registrosSeleccionadosBorrar.size > 0">
              <span class="seleccionados-count">{{ registrosSeleccionadosBorrar.size }} registro(s) seleccionado(s)</span>
              <button class="btn-round btn-danger" (click)="borrarRegistrosSeleccionados()">
                ğŸ—‘ï¸ Borrar Seleccionados
              </button>
            </div>
          </div>

          <!-- Sin registros inactivos -->
          <div *ngIf="registrosInactivosColeccion.length === 0" class="no-inactivos">
            <p>âœ¨ No hay registros inactivos en esta colecciÃ³n</p>
          </div>
        </div>

        <p class="warning-text" *ngIf="registrosSeleccionadosBorrar.size > 0">
          <mat-icon>warning</mat-icon>
          El borrado fÃ­sico es permanente y no se puede deshacer
        </p>
      </div>

      <hr class="divider">
      <div class="action-buttons">
        <button class="btn-emoji cancel" (click)="cerrarPopupBBDD()" title="Cerrar">âœ—</button>
      </div>
    </div>
  </div>
</div>

<!-- Popup Restore -->
<div class="modal-overlay" *ngIf="mostrarPopupRestore">
  <div class="auth-card db-popup">
    <h2 class="form-title">
      <mat-icon class="title-icon">restore</mat-icon>
      Restaurar Base de Datos
    </h2>
    <hr class="divider">
    <div class="form-content">
      <p>Selecciona la versiÃ³n a la que deseas restaurar:</p>
      
      <div class="version-list">
        <label *ngFor="let version of versionesRestore" class="version-item" 
               [class.selected]="selectedRestore === version.id">
          <input type="radio" 
                 name="restoreVersion" 
                 [value]="version.id"
                 [(ngModel)]="selectedRestore">
          <div class="version-info">
            <span class="version-fecha">{{ version.fecha }}</span>
            <span class="version-desc">{{ version.descripcion }}</span>
          </div>
        </label>
      </div>

      <p class="warning-text" *ngIf="selectedRestore">
        <mat-icon>info</mat-icon>
        Se restaurarÃ¡ la base de datos al estado del {{ fechaRestoreSeleccionada }}
      </p>

      <hr class="divider">
      <div class="action-buttons">
        <button class="btn-emoji cancel" (click)="cerrarPopupBBDD()" title="Cancelar">âœ—</button>
        <button class="btn-emoji confirm" (click)="ejecutarRestore()" title="Restaurar">âœ“</button>
      </div>
    </div>
  </div>
</div>

<!-- Popup Backup -->
<div class="modal-overlay" *ngIf="mostrarPopupBackup">
  <div class="auth-card db-popup">
    <h2 class="form-title">
      <mat-icon class="title-icon">backup</mat-icon>
      Generar Backup
    </h2>
    <hr class="divider">
    <div class="form-content">

      <!-- Backup por colecciÃ³n individual -->
      <div class="backup-individual-section">
        <h4>ğŸ“‚ Backup Individual</h4>
        <p>Buscar una colecciÃ³n especÃ­fica y generar su backup:</p>
        
        <div class="collection-search">
          <div class="input-field">
            <label>Nombre de la colecciÃ³n:</label>
            <input type="text" [(ngModel)]="coleccionBackup" placeholder="Ej: usuarios" class="collection-input">
          </div>
          <button class="btn-round btn-search" (click)="buscarColeccionBackup()" [disabled]="!coleccionBackup">
            ğŸ” Buscar
          </button>
        </div>
        <div *ngIf="coleccionBackupEncontrada" class="collection-found">
          <p>âœ… ColecciÃ³n encontrada: <strong>{{ coleccionBackup }}</strong> ({{ registrosColeccionBackup }} registros)</p>
          <button class="btn-round btn-blue btn-sm" (click)="backupColeccion()">
            ğŸ’¾ Backup ColecciÃ³n
          </button>
        </div>
        <div *ngIf="coleccionBackupNoEncontrada" class="collection-not-found">
          <p>âŒ No se encontrÃ³ la colecciÃ³n "{{ coleccionBackup }}"</p>
        </div>
      </div>

      <hr class="divider">

      <!-- Backup Completo -->
      <div class="backup-completo-section">
        <h4>ğŸ“¦ Backup Completo</h4>
        <p>Genera una copia de seguridad de <strong>todas las colecciones</strong> de la base de datos.</p>
        <button class="btn-round btn-primary btn-full" 
                (click)="ejecutarBackupCompleto()" 
                [disabled]="backupCompletoEnProgreso">
          <span *ngIf="!backupCompletoEnProgreso">ğŸ’¾ Backup</span>
          <span *ngIf="backupCompletoEnProgreso">â³ Generando...</span>
        </button>
      </div>

      <hr class="divider">
      <div class="action-buttons">
        <button class="btn-emoji cancel" (click)="cerrarPopupBBDD()" title="Cerrar">âœ—</button>
      </div>
    </div>
  </div>
</div>