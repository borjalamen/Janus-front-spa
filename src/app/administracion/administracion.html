<div class="section-container admin-layout admin-top-tabs">
  
  <div class="admin-top-nav">
    <h2 class="admin-top-title">{{ 'ADMIN.PANEL_TITLE' | translate }}</h2>
    <div class="admin-top-tabs-bar">
      <button class="menu-btn" 
              [class.active]="activeTab === 'USERS'" 
              (click)="cambiarTab('USERS')">
        <span class="menu-emoji">üë•</span> {{ 'ADMIN.TAB_USERS' | translate }}
      </button>
      
      <button class="menu-btn" 
              [class.active]="activeTab === 'APP'" 
              (click)="cambiarTab('APP')">
        <span class="menu-emoji">‚öôÔ∏è</span> {{ 'ADMIN.TAB_APP' | translate }}
      </button>
      
      <button class="menu-btn" 
              [class.active]="activeTab === 'PARAM'" 
              (click)="cambiarTab('PARAM')">
        <span class="menu-emoji">üéõÔ∏è</span> {{ 'ADMIN.TAB_PARAM' | translate }}
      </button>
      
      <button class="menu-btn" 
              [class.active]="activeTab === 'DB'" 
              (click)="cambiarTab('DB')">
        <span class="menu-emoji">üóÑÔ∏è</span> {{ 'ADMIN.TAB_DB' | translate }}
      </button>

      <button class="menu-btn" 
              [class.active]="activeTab === 'REQUESTS'" 
              (click)="cambiarTab('REQUESTS')">
        <span class="menu-emoji">üìù</span> {{ 'ADMIN.TAB_REQUESTS' | translate }}
      </button>
    </div>
  </div>

  <div class="admin-content">

    <div *ngIf="activeTab === 'USERS'" class="tab-content fade-in">
      <div class="documents-header">
        <h2>{{ 'ADMIN.MANAGE_USERS' | translate }}</h2>
        <button class="jenkins-add-btn" *ngIf="canEdit" (click)="obrirPopupCrear()">
          <mat-icon>add</mat-icon> {{ 'ADMIN.ADD_USER' | translate }}
        </button>
      </div>

      <app-buscador (buscar)="filtrar($event)" style="margin-bottom: 20px; display: block;"></app-buscador>

      <div class="users-list">
        <div *ngFor="let usuari of usuarisFiltrats" class="usuari-item">
          <div>
            <div class="usuari-nom">
              <b>{{ usuari.fullName }}</b>
              <span class="usuari-rol">({{ usuari.roles.join(', ') }})</span>
            </div>
            <div class="usuari-email">{{ usuari.email }}</div>
          </div>

          <div class="actions">
            <button class="icon-btn view-profile" (click)="verPerfil(usuari)" [title]="'ADMIN.VIEW_FULL_PROFILE' | translate">
              <span class="emoji-icon">üëÅÔ∏è</span>
            </button>
            <button class="icon-btn edit" *ngIf="canEdit" (click)="obrirPopupEditar(usuari)" [title]="'ADMIN.UPDATE_USER' | translate">
              <span class="emoji-icon">‚úèÔ∏è</span>
            </button>
            <button class="icon-btn delete" *ngIf="canEdit" (click)="confirmarInhabilitar(usuari)" [title]="'ADMIN.DISABLE_USER' | translate">
              <span class="emoji-icon">üóëÔ∏è</span>
            </button>
          </div>
        </div>
      </div>
    </div>

    <div *ngIf="activeTab === 'APP'" class="tab-content fade-in">
      <div class="documents-header">
        <h2>{{ 'ADMIN.MANAGE_APP' | translate }}</h2>
      </div>
      
      <div class="admin-card">
        <h3>{{ 'ADMIN.DISABLE_BY_ROLES' | translate }}</h3>
        <p>{{ 'ADMIN.DISABLE_DESCRIPTION' | translate }}</p>
        
        <div class="form-field">
            <label>{{ 'ADMIN.SELECT_ROLE' | translate }}</label>
            <select [(ngModel)]="selectedRoleToDisable" class="custom-select">
                <option value="" disabled selected>{{ 'ADMIN.CHOOSE' | translate }}</option>
                <option value="CONSULTOR">{{ 'ADMIN.CONSULTANT' | translate }}</option>
                <option value="DEV">{{ 'ADMIN.DEVOPS' | translate }}</option>
            </select>
        </div>
        
        <div style="margin-top: 16px; text-align: right;">
            <button class="jenkins-add-btn" (click)="inhabilitarPorRol()">
                {{ 'ADMIN.DISABLE_ACCESS' | translate }}
            </button>
        </div>
      </div>
    </div>

    <div *ngIf="activeTab === 'PARAM'" class="tab-content fade-in">
      <div class="documents-header">
        <h2>{{ 'ADMIN.PARAMETERIZATION' | translate }}</h2>
      </div>

      <div class="admin-card">
        <h3>{{ 'ADMIN.VERSION_CHANGE' | translate }}</h3>
        <p>{{ 'ADMIN.VERSION_MANAGEMENT' | translate }}</p>
        
        <div class="form-field">
            <label>{{ 'ADMIN.SYSTEM_VERSION' | translate }}</label>
            <input type="text" [(ngModel)]="appVersion" placeholder="Ej: 1.0.0">
        </div>

        <div style="margin-top: 16px; text-align: right;">
            <button class="jenkins-add-btn" (click)="cambiarVersion()">
                <mat-icon>update</mat-icon> {{ 'ADMIN.UPDATE_VERSION' | translate }}
            </button>
        </div>
      </div>
    </div>

    <div *ngIf="activeTab === 'DB'" class="tab-content fade-in">
      <div class="documents-header">
        <h2>{{ 'ADMIN.DB_MANAGEMENT' | translate }}</h2>
      </div>

      <div class="db-grid">
        <div class="admin-card db-card">
            <span class="big-emoji warn">üóëÔ∏è</span>
            <h3>{{ 'ADMIN.PHYSICAL_DELETE' | translate }}</h3>
            <p>{{ 'ADMIN.DELETE_DESCRIPTION' | translate }}</p>
            <button class="popup-btn" (click)="accionBBDD('borrado')">{{ 'ADMIN.SELECT_AND_EXECUTE' | translate }}</button>
        </div>

        <div class="admin-card db-card">
            <span class="big-emoji">üîÑ</span>
            <h3>{{ 'ADMIN.RESTORE' | translate }}</h3>
            <p>{{ 'ADMIN.RESTORE_DESCRIPTION' | translate }}</p>
            <button class="popup-btn" (click)="accionBBDD('restore')">{{ 'ADMIN.CHOOSE_VERSION' | translate }}</button>
        </div>

        <div class="admin-card db-card">
            <span class="big-emoji">üíæ</span>
            <h3>{{ 'ADMIN.BACKUP' | translate }}</h3>
            <p>{{ 'ADMIN.BACKUP_DESCRIPTION' | translate }}</p>
            <button class="popup-btn" (click)="accionBBDD('backup')">{{ 'ADMIN.SELECT_AND_GENERATE' | translate }}</button>
        </div>
      </div>
    </div>

    <div *ngIf="activeTab === 'REQUESTS'" class="tab-content fade-in">
      <div class="documents-header">
        <h2>{{ 'ADMIN.REQUESTS' | translate }}</h2>
        <div class="requests-summary">
          <span class="status-pill pendiente" 
                [class.active]="filtroEstadoPeticiones === 'PENDIENTE'"
                (click)="filtrarPorEstado('PENDIENTE')"
                style="cursor: pointer;">
            {{ peticionesPendientes }} {{ 'ADMIN.PENDING' | translate }}
          </span>
          <span class="status-pill aprobada" 
                [class.active]="filtroEstadoPeticiones === 'APROBADA'"
                (click)="filtrarPorEstado('APROBADA')"
                style="cursor: pointer;">
            {{ peticionesAprobadas }} {{ 'ADMIN.APPROVED' | translate }}
          </span>
          <span class="status-pill rechazada" 
                [class.active]="filtroEstadoPeticiones === 'RECHAZADA'"
                (click)="filtrarPorEstado('RECHAZADA')"
                style="cursor: pointer;">
            {{ peticionesRechazadas }} {{ 'ADMIN.REJECTED' | translate }}
          </span>
          <span class="status-pill" 
                [class.active]="filtroEstadoPeticiones === 'TODAS'"
                (click)="filtrarPorEstado('TODAS')"
                style="cursor: pointer;">
            {{ peticiones.length }} {{ 'ADMIN.ALL' | translate }}
          </span>
        </div>
      </div>

      <app-buscador (buscar)="filtrarPeticiones($event)" style="margin-bottom: 20px; display: block;"></app-buscador>

      <div class="requests-list">
        <div *ngFor="let peticion of peticionesFiltradas" class="admin-card request-card">
          <div class="request-header">
            <div class="request-title">
              <span class="request-id">#{{ peticion.id }}</span>
              <span class="request-type">{{ peticion.tipo }}</span>
            </div>
            <span class="status-pill" [ngClass]="peticion.estado.toLowerCase()">{{ (getStatusTranslation(peticion.estado)) | translate }}</span>
          </div>
          <div class="request-meta">
            <span>üë§ {{ peticion.solicitante }}</span>
            <span>üìÖ {{ peticion.fecha }}</span>
          </div>
          <p class="request-note">{{ peticion.comentario }}</p>
          <div class="request-actions" *ngIf="peticion.estado === 'PENDIENTE'">
            <button class="btn-emoji confirm" (click)="aprobarPeticion(peticion)" [disabled]="!canEdit">
              ‚úì
            </button>
            <button class="btn-emoji cancel" (click)="rechazarPeticion(peticion)" [disabled]="!canEdit">
              ‚úó
            </button>
          </div>
        </div>

        <div *ngIf="peticionesFiltradas.length === 0" class="empty-state">
          {{ 'ADMIN.DELETE_CONFIRMATION_MSG' | translate }}
        </div>
      </div>
    </div>

  </div>
</div>
<div class="modal-overlay" *ngIf="mostrarPopup">
  <div class="auth-card">
    <h2 class="form-title">{{ usuariEditant ? ('ADMIN.EDIT_USER' | translate) : ('ADMIN.NEW_USER' | translate) }}</h2>
    <hr class="divider">

    <div class="form-content">
      <div class="input-field">
        <label>{{ 'ADMIN.NAME' | translate }}</label>
        <input type="text" [(ngModel)]="nouUsuari.nombre" placeholder="jlopez">
      </div>

      <div class="input-field">
        <label>{{ 'ADMIN.EMAIL' | translate }}</label>
        <input type="email" [(ngModel)]="nouUsuari.email" placeholder="jlopez@minsait.com">
      </div>

      <div class="input-field">
        <label>{{ 'ADMIN.PASSWORD' | translate }}</label>
        <input type="password" [(ngModel)]="nouUsuari.contrasenya" [placeholder]="usuariEditant ? ('ADMIN.KEEP_PASSWORD' | translate) : ('ADMIN.ENTER_PASSWORD' | translate)">
      </div>

      <hr class="divider">

      <label class="section-label">{{ 'ADMIN.USER_ROLES' | translate }}</label>
      
      <div class="roles-grid">
        <div class="switch-item">
          <label class="custom-switch">
            <input type="checkbox" [(ngModel)]="nouUsuari.rols.admin">
            <span class="custom-slider"></span>
          </label>
          <span class="role-text">{{ 'ADMIN.ADMINISTRATOR' | translate }}</span>
        </div>

        <div class="switch-item">
          <label class="custom-switch">
            <input type="checkbox" [(ngModel)]="nouUsuari.rols.consultor">
            <span class="custom-slider"></span>
          </label>
          <span class="role-text">{{ 'ADMIN.CONSULTANT' | translate }}</span>
        </div>

        <div class="switch-item">
          <label class="custom-switch">
            <input type="checkbox" [(ngModel)]="nouUsuari.rols.devops">
            <span class="custom-slider"></span>
          </label>
          <span class="role-text">{{ 'ADMIN.DEVOPS' | translate }}</span>
        </div>
      </div>

      <hr class="divider">

      <div class="action-buttons">
        <button class="btn-emoji cancel" (click)="tancarPopup()" [title]="'ADMIN.CANCEL' | translate">‚úó</button>
        <button class="btn-emoji confirm" (click)="guardarUsuari()" [title]="'ADMIN.SAVE' | translate">‚úì</button>
      </div>
    </div>
  </div>
</div>

<!-- Popup confirmaci√≥n eliminar usuario -->
<div class="modal-overlay" *ngIf="mostrarPopupDelete">
  <div class="auth-card">
    <h2 class="form-title">{{ 'ADMIN.DELETE_USER' | translate }}</h2>
    <hr class="divider">
    <div class="form-content">
      <p>{{ 'ADMIN.DELETE_CONFIRMATION' | translate }} <strong>{{ usuariAEsborrar?.fullName }}</strong>?</p>
      <p style="color: #ff6b6b; font-size: 0.9em;">{{ 'ADMIN.IRREVERSIBLE_ACTION' | translate }}</p>
      <hr class="divider">
      <div class="action-buttons">
        <button class="btn-emoji cancel" (click)="cancelarInhabilitar()" [title]="'ADMIN.CANCEL' | translate">‚úó</button>
        <button class="btn-emoji confirm" (click)="inhabilitarUsuari()" [title]="'ADMIN.DELETE' | translate">‚úì</button>
      </div>
    </div>
  </div>
</div>

<!-- Popup Borrado F√≠sico -->
<div class="modal-overlay" *ngIf="mostrarPopupBorrado">
  <div class="auth-card db-popup db-popup-large">
    <h2 class="form-title">
      <span class="title-emoji">üóëÔ∏è</span>
      {{ 'ADMIN.PHYSICAL_DELETE' | translate }}
    </h2>
    <hr class="divider">
    <div class="form-content">
      
      <!-- B√∫squeda de colecci√≥n -->
      <div class="borrado-section">
        <h4>üìÇ {{ 'ADMIN.COLLECTION_SEARCH' | translate }}</h4>
        <p>{{ 'ADMIN.SEARCH_COLLECTION_DESC' | translate }}</p>
        
        <div class="collection-search">
          <div class="input-field">
            <label>{{ 'ADMIN.COLLECTION_NAME' | translate }}</label>
            <input type="text" 
                   [(ngModel)]="coleccionBorrar" 
                   placeholder="Ej: usuarios, documentos, logs, sesiones"
                   class="collection-input"
                   (keyup.enter)="buscarColeccion()">
          </div>
          <button class="btn-round btn-search" (click)="buscarColeccion()" [disabled]="!coleccionBorrar || cargandoRegistrosInactivos">
            <span *ngIf="!cargandoRegistrosInactivos">{{ 'ADMIN.SEARCH' | translate }}</span>
            <span *ngIf="cargandoRegistrosInactivos">{{ 'ADMIN.LOADING' | translate }}</span>
          </button>
        </div>

        <!-- Colecci√≥n no encontrada -->
        <div *ngIf="coleccionNoEncontrada" class="collection-not-found">
          <p>‚ùå {{ 'ADMIN.COLLECTION_NOT_FOUND' | translate }} "{{ coleccionBorrar }}"</p>
        </div>

        <!-- Colecci√≥n encontrada con registros inactivos -->
        <div *ngIf="coleccionEncontrada" class="collection-found-detail">
          <div class="collection-header">
            <div class="collection-info">
              <p>‚úÖ {{ 'ADMIN.COLLECTION' | translate }} <strong>{{ coleccionBorrar }}</strong></p>
              <p class="stats">üìä {{ 'ADMIN.TOTAL' | translate }} {{ registrosColeccion }} {{ 'ADMIN.RECORDS' | translate }} | üö´ {{ 'ADMIN.INACTIVE' | translate }} <strong>{{ registrosInactivos }}</strong></p>
            </div>
            <button class="btn-round btn-secondary btn-sm" (click)="limpiarBusquedaColeccion()">
              ‚úï {{ 'ADMIN.CLEAR' | translate }}
            </button>
          </div>

          <!-- Lista de registros inactivos -->
          <div *ngIf="registrosInactivosColeccion.length > 0" class="registros-inactivos-list">
            <div class="seleccionar-todos">
              <label class="custom-checkbox">
                <input type="checkbox" 
                       [checked]="registrosSeleccionadosBorrar.size === registrosInactivosColeccion.length && registrosInactivosColeccion.length > 0"
                       (change)="seleccionarTodosRegistros()">
                <span class="checkmark"></span>
                <span>{{ 'ADMIN.SELECT_ALL' | translate }} ({{ registrosInactivosColeccion.length }})</span>
              </label>
            </div>
            
            <div class="registros-scroll">
              <div *ngFor="let registro of registrosInactivosColeccion" class="registro-inactivo-item">
                <label class="custom-checkbox">
                  <input type="checkbox" 
                         [checked]="registrosSeleccionadosBorrar.has(registro.id)"
                         (change)="toggleSeleccionRegistro(registro.id)">
                  <span class="checkmark"></span>
                  <div class="registro-info">
                    <div class="registro-header">
                      <span class="registro-id">{{ registro.id }}</span>
                      <span class="registro-fecha">üìÖ {{ registro.fechaInactivacion }}</span>
                    </div>
                    <span class="registro-nombre">{{ registro.nombre }}</span>
                    <span class="registro-descripcion">{{ registro.descripcion }}</span>
                  </div>
                </label>
              </div>
            </div>
            
            <div class="borrar-registros-actions" *ngIf="registrosSeleccionadosBorrar.size > 0">
              <span class="seleccionados-count">{{ registrosSeleccionadosBorrar.size }} registro(s) seleccionado(s)</span>
              <button class="btn-round btn-danger" (click)="borrarRegistrosSeleccionados()">
                üóëÔ∏è {{ 'ADMIN.SELECT_AND_EXECUTE' | translate }}
              </button>
            </div>
          </div>

          <!-- Sin registros inactivos -->
          <div *ngIf="registrosInactivosColeccion.length === 0" class="no-inactivos">
            <p>‚ú® {{ 'ADMIN.NO_INACTIVE' | translate }}</p>
          </div>
        </div>

        <p class="warning-text" *ngIf="registrosSeleccionadosBorrar.size > 0">
          <mat-icon>warning</mat-icon>
          {{ 'ADMIN.PERMANENT_DELETE' | translate }}
        </p>
      </div>

      <hr class="divider">
      <div class="action-buttons">
        <button class="btn-emoji cancel" (click)="cerrarPopupBBDD()" [title]="'ADMIN.CLOSE' | translate">‚úó</button>
      </div>
    </div>
  </div>
</div>

<!-- Popup Restore -->
<div class="modal-overlay" *ngIf="mostrarPopupRestore">
  <div class="auth-card db-popup">
    <h2 class="form-title">
      <mat-icon class="title-icon">restore</mat-icon>
      {{ 'ADMIN.RESTORE_DATABASE' | translate }}
    </h2>
    <hr class="divider">
    <div class="form-content">
      <p>{{ 'ADMIN.SELECT_RESTORE_VERSION' | translate }}</p>
      
      <div class="version-list">
        <label *ngFor="let version of versionesRestore" class="version-item" 
               [class.selected]="selectedRestore === version.id">
          <input type="radio" 
                 name="restoreVersion" 
                 [value]="version.id"
                 [(ngModel)]="selectedRestore">
          <div class="version-info">
            <span class="version-fecha">{{ version.fecha }}</span>
            <span class="version-desc">{{ version.descripcion }}</span>
          </div>
        </label>
      </div>

      <p class="warning-text" *ngIf="selectedRestore">
        <mat-icon>info</mat-icon>
        {{ 'ADMIN.RESTORE_STATE' | translate }} {{ fechaRestoreSeleccionada }}
      </p>

      <hr class="divider">
      <div class="action-buttons">
        <button class="btn-emoji cancel" (click)="cerrarPopupBBDD()" [title]="'ADMIN.CANCEL' | translate">‚úó</button>
        <button class="btn-emoji confirm" (click)="ejecutarRestore()" [title]="'ADMIN.RESTORE_ACTION' | translate">‚úì</button>
      </div>
    </div>
  </div>
</div>

<!-- Popup Backup -->
<div class="modal-overlay" *ngIf="mostrarPopupBackup">
  <div class="auth-card db-popup">
    <h2 class="form-title">
      <mat-icon class="title-icon">backup</mat-icon>
      {{ 'ADMIN.GENERATE_BACKUP' | translate }}
    </h2>
    <hr class="divider">
    <div class="form-content">

      <!-- Backup por colecci√≥n individual -->
      <div class="backup-individual-section">
        <h4>üìÇ {{ 'ADMIN.INDIVIDUAL_BACKUP' | translate }}</h4>
        <p>{{ 'ADMIN.SEARCH_SPECIFIC' | translate }}</p>
        
        <div class="collection-search">
          <div class="input-field">
            <label>{{ 'ADMIN.COLLECTION_NAME' | translate }}</label>
            <input type="text" [(ngModel)]="coleccionBackup" placeholder="Ej: usuarios" class="collection-input">
          </div>
          <button class="btn-round btn-search" (click)="buscarColeccionBackup()" [disabled]="!coleccionBackup">
            {{ 'ADMIN.SEARCH' | translate }}
          </button>
        </div>
        <div *ngIf="coleccionBackupEncontrada" class="collection-found">
          <p>‚úÖ {{ 'ADMIN.COLLECTION_FOUND_INFO' | translate }} <strong>{{ coleccionBackup }}</strong> ({{ registrosColeccionBackup }} {{ 'ADMIN.RECORDS' | translate }})</p>
          <button class="btn-round btn-blue btn-sm" (click)="backupColeccion()">
            {{ 'ADMIN.BACKUP_BTN' | translate }}
          </button>
        </div>
        <div *ngIf="coleccionBackupNoEncontrada" class="collection-not-found">
          <p>‚ùå {{ 'ADMIN.COLLECTION_NOT_FOUND' | translate }} "{{ coleccionBackup }}"</p>
        </div>
      </div>

      <hr class="divider">

      <!-- Backup Completo -->
      <div class="backup-completo-section">
        <h4>üì¶ {{ 'ADMIN.FULL_BACKUP' | translate }}</h4>
        <p>{{ 'ADMIN.FULL_BACKUP_DESC' | translate }}</p>
        <button class="btn-round btn-primary btn-full" 
                (click)="ejecutarBackupCompleto()" 
                [disabled]="backupCompletoEnProgreso">
          <span *ngIf="!backupCompletoEnProgreso">{{ 'ADMIN.BACKUP_BTN' | translate }}</span>
          <span *ngIf="backupCompletoEnProgreso">{{ 'ADMIN.GENERATING' | translate }}</span>
        </button>
      </div>

      <hr class="divider">
      <div class="action-buttons">
        <button class="btn-emoji cancel" (click)="cerrarPopupBBDD()" [title]="'ADMIN.CLOSE' | translate">‚úó</button>
      </div>
    </div>
  </div>
</div>