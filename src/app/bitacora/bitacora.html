<app-buscador (buscar)="filtrar($event)"></app-buscador>

<div class="section-container">
  <div class="documents-header">
    <h2>{{ 'ERRORS.TITLE' | translate }}</h2>
  </div>

  <!-- Pesta√±as -->
  <div class="tabs">
    <button class="tab" [class.active]="activeTab==='crear'" (click)="activeTab='crear'">
      <mat-icon inline="true">add</mat-icon>
      {{ 'ERRORS.TAB_CREATE' | translate }}
    </button>
    <button class="tab" [class.active]="activeTab==='listar'" (click)="activeTab='listar'; cerrarVisualizacion()">
      <mat-icon inline="true">list</mat-icon>
      {{ 'ERRORS.TAB_LIST' | translate }}
    </button>
  </div>

  <!-- Pesta√±a: Crear/Editar -->
  <div *ngIf="activeTab==='crear'" class="tab-panel">
    <div class="form-container">
      <h3>{{ (editando ? 'ERRORS.EDIT_TITLE' : 'ERRORS.NEW_TITLE') | translate }}</h3>

      <div class="form-field">
        <label>{{ 'ERRORS.FIELD_CONTEXT' | translate }}</label>
        <input type="text" [(ngModel)]="formBitacora.contexto" placeholder="Contexto del error" />
      </div>

      <div class="form-field">
        <label>{{ 'ERRORS.FIELD_ERROR' | translate }}</label>
        <textarea rows="3" [(ngModel)]="formBitacora.error" placeholder="Descripci√≥n del error"></textarea>
      </div>

      <div class="form-field">
        <label>Entorno</label>
        <div class="entorno-botones-wrapper">
          <button type="button" class="entorno-btn" [class.active]="formBitacora.entorno === 'minsait'" (click)="formBitacora.entorno = 'minsait'" [style.--color]="'#1E88E5'" title="Minsait">
            Minsait
          </button>
          <button type="button" class="entorno-btn" [class.active]="formBitacora.entorno === 'preproduccion'" (click)="formBitacora.entorno = 'preproduccion'" [style.--color]="'#FBC02D'" title="Preproducci√≥n">
            Preproducci√≥n
          </button>
          <button type="button" class="entorno-btn" [class.active]="formBitacora.entorno === 'produccion'" (click)="formBitacora.entorno = 'produccion'" [style.--color]="'#E53935'" title="Producci√≥n">
            Producci√≥n
          </button>
          <div class="entorno-icon-preview" [style.background]="'linear-gradient(135deg, ' + getColorEntorno(formBitacora.entorno) + ', ' + getColorEntorno(formBitacora.entorno) + 'cc)'">
            <mat-icon [style.color]="getColorEntorno(formBitacora.entorno)">bug_report</mat-icon>
          </div>
        </div>
      </div>

      <div class="form-field solutions-field">
        <div class="solutions-header">
          <label>{{ 'ERRORS.FIELD_SOLUTION' | translate }}</label>
        </div>
        <div class="soluciones-container">
          <button type="button" class="guardar-btn agregar-solucion-btn" (click)="agregarSolucion()" title="Agregar Soluci√≥n">
            <mat-icon>add</mat-icon>
          </button>
          <div *ngIf="!formBitacora.soluciones || formBitacora.soluciones.length === 0" class="no-soluciones">
            <p>No hay soluciones agregadas</p>
          </div>
          
          <div *ngFor="let solucion of formBitacora.soluciones; let i = index" class="solucion-item">
            <div class="solucion-header">
              <span class="solucion-numero">Paso {{ solucion.numero }}</span>
              <select [(ngModel)]="solucion.entorno" class="solucion-entorno-select" [style.borderColor]="getColorEntorno(solucion.entorno)">
                <option value="minsait">üîµ Minsait</option>
                <option value="preproduccion">üü° Preproducci√≥n</option>
                <option value="produccion">üî¥ Producci√≥n</option>
              </select>
              <button type="button" class="eliminar-solucion-btn" (click)="eliminarSolucion(i)" title="Eliminar soluci√≥n">
                <mat-icon>close</mat-icon>
              </button>
            </div>
            <div class="solucion-content-wrapper">
              <input type="file" #fileInput style="display: none;" />
              <button type="button" class="file-btn" (click)="fileInput.click()" title="A√±adir archivo">
                <img src="assets/images/File.png" alt="Archivo">
              </button>
              <textarea 
                [(ngModel)]="solucion.descripcion" 
                rows="2" 
                placeholder="Descripci√≥n de la soluci√≥n"
                class="solucion-textarea">
              </textarea>
            </div>
          </div>
        </div>
      </div>

      <div class="form-field fecha-tags-wrapper">
        <div class="fecha-tags-labels">
          <label class="fecha-label">{{ 'ERRORS.FIELD_DATE' | translate }}</label>
          <label class="tags-label">{{ 'ERRORS.FIELD_TAGS' | translate }}</label>
        </div>
        <div class="fecha-tags-input-wrapper">
          <input type="date" #calendarioInput [(ngModel)]="formBitacora.fecha" class="calendario-input" />
          <button type="button" class="calendario-btn" (click)="calendarioInput.showPicker()" title="Seleccionar fecha">
            <mat-icon>calendar_today</mat-icon>
          </button>
          <span class="fecha-display">{{ formBitacora.fecha || 'Sin fecha' }}</span>
          <input type="text" [(ngModel)]="tagsInput" placeholder="Tags separados por coma" class="tags-input" />
        </div>
      </div>

      <div class="form-actions">
        <button class="cancelar-btn" (click)="cerrarPopup()" title="Cancelar">
          ‚úó
        </button>
        <button class="guardar-btn" (click)="guardarBitacora()" [title]="editando ? 'Actualizar' : 'Guardar'">
          ‚úì
        </button>
      </div>
    </div>
  </div>

  <!-- Pesta√±a: Listar -->
  <div *ngIf="activeTab==='listar'" class="tab-panel">
    <p>{{ 'ERRORS.DESCRIPTION' | translate }}</p>

    <div class="bitacora-list" *ngIf="erroresFiltrados.length > 0">
      <div *ngFor="let e of erroresFiltrados" class="bitacora-row">
        <div class="bitacora-icon" [style.background]="'linear-gradient(135deg, ' + getColorEntorno(e.entorno) + ', ' + getColorEntorno(e.entorno) + 'cc)'">
          <mat-icon [style.color]="getColorEntorno(e.entorno)">bug_report</mat-icon>
        </div>
        
        <div class="bitacora-info">
          <div class="bitacora-title-row">
            <strong class="bitacora-contexto">{{ e.contexto || '(Sin contexto)' }}</strong>
            <span class="bitacora-fecha">{{ e.fecha }}</span>
          </div>
          <div class="bitacora-error">{{ e.error }}</div>
          
          <div class="bitacora-soluciones" *ngIf="e.soluciones && e.soluciones.length > 0" [style.borderLeftColor]="getColorEntorno(e.soluciones[0]?.entorno || e.entorno)">
            <div *ngFor="let solucion of e.soluciones" class="solucion-display">
              <mat-icon class="bombilla-icon" [style.color]="getColorEntorno(solucion.entorno)">lightbulb</mat-icon>
              <div class="solucion-text">
                <strong>Paso {{ solucion.numero }} - {{ getNombreEntorno(solucion.entorno) }}</strong>
                <p>{{ solucion.descripcion }}</p>
              </div>
            </div>
          </div>
          
          <div class="bitacora-tags" *ngIf="e.tags && e.tags.length > 0">
            <span class="tag" *ngFor="let tag of e.tags">{{ tag }}</span>
          </div>
          
          <div class="bitacora-actions">
            <button class="action-btn view-btn" (click)="toggleVisualizacion(e)" title="Ver pasos" *ngIf="e.soluciones && e.soluciones.length > 0">
              <mat-icon>{{ bitacoraVisualizacion?.id === e.id && mostrarVisualizacion ? 'visibility_off' : 'visibility' }}</mat-icon>
            </button>
            <button class="action-btn edit-btn" (click)="abrirPopupEditar(e)" title="Editar">
              ‚úèÔ∏è
            </button>
            <button class="action-btn delete-btn" (click)="confirmarEliminar(e)" title="Eliminar">
              üóëÔ∏è
            </button>
          </div>
        </div>
      </div>
      
      <!-- Visualizaci√≥n de soluci√≥n inline -->
      <div class="solution-inline-container" *ngIf="mostrarVisualizacion && bitacoraVisualizacion">
        <div class="solution-inline-header">
          <h3>{{ bitacoraVisualizacion.contexto || '(Sin contexto)' }}</h3>
          <button class="close-inline-btn" (click)="cerrarVisualizacion()" title="Cerrar">
            <mat-icon>close</mat-icon>
          </button>
        </div>
        <p class="solution-inline-error">{{ bitacoraVisualizacion.error }}</p>
        <div class="solution-entorno-badge" [style.backgroundColor]="getColorEntorno(bitacoraVisualizacion.entorno)" [style.borderColor]="getColorEntorno(bitacoraVisualizacion.entorno)">
          {{ getNombreEntorno(bitacoraVisualizacion.entorno) }}
        </div>
        <div class="solution-steps" *ngIf="bitacoraVisualizacion.soluciones && bitacoraVisualizacion.soluciones.length > 0">
          <div *ngFor="let solucion of bitacoraVisualizacion.soluciones" class="step-item">
            <div class="step-header">
              <div class="step-title">
                <strong>Paso {{ solucion.numero }} - {{ getNombreEntorno(solucion.entorno) }}</strong>
              </div>
            </div>
            <div class="step-content">
              {{ solucion.descripcion }}
            </div>
          </div>
        </div>
      </div>
    </div>

    <div *ngIf="erroresFiltrados.length === 0" class="no-results">
      <mat-icon>search_off</mat-icon>
      <p>{{ 'ERRORS.NO_RESULTS' | translate }}</p>
    </div>
  </div>

  <!-- Pesta√±a: Soluci√≥n (Animada) - ELIMINADA -->
  <div *ngIf="false" class="tab-panel solution-panel">
    <div class="solution-container" *ngIf="bitacoraVisualizacion">
      <div class="solution-header">
        <button class="close-solution-btn" (click)="activeTab='listar'; cerrarVisualizacion()" title="Cerrar">
          <mat-icon>close</mat-icon>
        </button>
        <div class="solution-title-info">
          <h3>{{ bitacoraVisualizacion!.contexto || '(Sin contexto)' }}</h3>
          <p class="solution-error">{{ bitacoraVisualizacion!.error }}</p>
        </div>
      </div>

      <div class="solution-entorno-badge" [style.backgroundColor]="getColorEntorno(bitacoraVisualizacion!.entorno)" [style.borderColor]="getColorEntorno(bitacoraVisualizacion!.entorno)">
        {{ getNombreEntorno(bitacoraVisualizacion!.entorno) }}
      </div>

      <div class="solution-steps" *ngIf="bitacoraVisualizacion!.soluciones && bitacoraVisualizacion!.soluciones.length > 0">
        <div *ngFor="let solucion of bitacoraVisualizacion!.soluciones" class="step-item">
          <div class="step-header">
            <div class="step-title">
              <strong>Paso {{ solucion.numero }} - {{ getNombreEntorno(solucion.entorno) }}</strong>
            </div>
          </div>
          <div class="step-content">
            {{ solucion.descripcion }}
          </div>
        </div>
      </div>

      <div class="no-solutions" *ngIf="!bitacoraVisualizacion || !bitacoraVisualizacion!.soluciones || bitacoraVisualizacion!.soluciones.length === 0">
        <mat-icon>lightbulb_outline</mat-icon>
        <p>No hay soluciones agregadas</p>
      </div>
    </div>
  </div>
</div>

<!-- Popup eliminar -->
<div class="popup-fons" *ngIf="mostrarPopupDelete" (click)="cancelarEliminar()">
  <div class="popup-container" (click)="$event.stopPropagation()">
    <h3>{{ 'ERRORS.DELETE_TITLE' | translate }}</h3>
    <p>{{ 'ERRORS.DELETE_CONFIRM' | translate }}</p>

    <div class="popup-actions">
      <button class="cancelar-btn" (click)="cancelarEliminar()" title="Cancelar">
      ‚úó
      </button>
      <button class="guardar-btn" (click)="eliminarBitacora()" title="Eliminar">
      ‚úì
      </button>
    </div>
  </div>
</div>
