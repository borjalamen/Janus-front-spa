<div class="estimacion-root">
  <h2>{{ 'ESTIMATION.TITLE' | translate }}</h2>

  <mat-tab-group [(selectedIndex)]="selectedTab">
    <mat-tab label="{{ 'ESTIMATION.TAB_DO' | translate }}">
  <!-- Metadata form (fill before starting the estimation) -->
  <div *ngIf="!started" class="metadata-form">
    <div class="row">
      <mat-form-field appearance="outline">
        <input matInput placeholder="{{ 'ESTIMATION_META.META_NAME' | translate }}" [(ngModel)]="estimationName" />
      </mat-form-field>
      <mat-form-field appearance="outline">
        <input matInput placeholder="{{ 'ESTIMATION_META.META_PROJECT_CODE' | translate }}" [(ngModel)]="projectCode" />
      </mat-form-field>
      <mat-form-field appearance="outline">
        <input matInput placeholder="{{ 'ESTIMATION_META.META_PROJECT_NAME' | translate }}" [(ngModel)]="projectName" />
      </mat-form-field>
    </div>

    <div class="row">
      <mat-form-field appearance="outline">
        <input matInput placeholder="{{ 'ESTIMATION_META.META_REQUESTER' | translate }}" [(ngModel)]="requester" />
      </mat-form-field>
      <mat-form-field appearance="outline">
        <input matInput placeholder="{{ 'ESTIMATION_META.META_REQUESTER_EMAIL' | translate }}" [(ngModel)]="requesterEmail" />
      </mat-form-field>
    </div>

    <div class="row">
      <mat-form-field appearance="outline" class="full">
        <textarea matInput rows="4" placeholder="{{ 'ESTIMATION_META.META_NOTES' | translate }}" [(ngModel)]="notes"></textarea>
      </mat-form-field>
    </div>

    <div class="row actions">
      <button mat-flat-button color="primary" (click)="started = true">{{ 'ESTIMATION_META.START' | translate }}</button>
    </div>
  </div>

  <div *ngIf="started" class="controls">
    <mat-form-field appearance="outline" class="task-field">
      <input matInput placeholder="{{ 'ESTIMATION.NEW_TASK' | translate }}" [(ngModel)]="newTaskTitle" maxlength="200" />
      <mat-hint align="end">{{ (newTaskTitle.length || 0) + '/200' }}</mat-hint>
    </mat-form-field>
    <button mat-flat-button color="primary" (click)="addTask()">{{ 'ESTIMATION.ADD_TASK' | translate }}</button>
    <button mat-stroked-button (click)="addWeek()">{{ 'ESTIMATION.ADD_WEEK' | translate }}</button>
    <button mat-stroked-button color="accent" (click)="started=false">{{ 'ESTIMATION_META.EDIT_METADATA' | translate }}</button>
    <span style="flex:1 1 auto"></span>
    <button mat-stroked-button class="export-btn" (click)="exportCsv()">{{ 'ESTIMATION_EXPORT.EXPORT_CSV' | translate }}</button>
    <button mat-stroked-button class="export-btn" (click)="exportPdf()">{{ 'ESTIMATION_EXPORT.EXPORT_PDF' | translate }}</button>
  </div>

  <div class="table-wrap">
    <table class="est-table">
      <thead>
        <tr>
          <th>{{ 'ESTIMATION.TASK' | translate }}</th>
          <th *ngFor="let w of weeks; let i = index">
            {{ 'ESTIMATION.WEEK' | translate }} {{ w }}
            <button class="small-link" (click)="removeWeek(i)">x</button>
          </th>
          <th>{{ 'ESTIMATION.TOTAL' | translate }}</th>
          <th></th>
        </tr>
      </thead>

      <tbody>
        <tr *ngFor="let t of tasks">
          <td class="task-title">{{ t.title }}</td>
          <td *ngFor="let w of weeks; let i = index">
            <input matInput type="number" min="0" step="0.5" [value]="t.estimates[i]" (input)="setEstimate(t, i, $any($event.target).value)" />
          </td>
          <td class="col-total">{{ totalForTask(t) | number:'1.2-2' }}</td>
          <td>
            <button mat-icon-button color="warn" (click)="removeTask(t.id)" title="{{ 'ESTIMATION.REMOVE_TASK' | translate }}">
              <mat-icon>delete</mat-icon>
            </button>
          </td>
        </tr>
      </tbody>

      <tfoot>
        <tr>
          <td><strong>{{ 'ESTIMATION.TOTAL' | translate }}</strong></td>
          <td *ngFor="let w of weeks; let i = index"><strong>{{ totalForWeek(i) | number:'1.2-2' }}</strong></td>
          <td><strong>{{ grandTotal() | number:'1.2-2' }}</strong></td>
          <td></td>
        </tr>
      </tfoot>
    </table>
  </div>
    </mat-tab>

    <mat-tab label="{{ 'ESTIMATION.TAB_LIST' | translate }}">
        <div class="desc-search">
          <mat-form-field appearance="outline" class="search-field">
            <mat-icon matPrefix>search</mat-icon>
            <input matInput type="search" [(ngModel)]="searchQuery" [placeholder]="'ESTIMATION.LIST_SEARCH' | translate" [attr.aria-label]="'ESTIMATION.LIST_SEARCH' | translate" />
            <button *ngIf="searchQuery" mat-icon-button matSuffix (click)="searchQuery='';" [attr.aria-label]="'DESCARGABLES.CLEAR' | translate" title="{{ 'DESCARGABLES.CLEAR' | translate }}">
              <mat-icon>close</mat-icon>
            </button>
          </mat-form-field>
        </div>

      <div class="list-table">
        <table class="est-table">
          <thead>
            <tr><th>{{ 'ESTIMATION.NAME' | translate }}</th><th>{{ 'ESTIMATION.PROJECT' | translate }}</th><th>{{ 'ESTIMATION.REQUESTER' | translate }}</th><th>{{ 'ESTIMATION.CREATED' | translate }}</th><th></th></tr>
          </thead>
          <tbody>
            <tr *ngFor="let s of filteredSavedEstimations">
              <td>{{ s.estimationName }}</td>
              <td>{{ s.projectCode }} - {{ s.projectName }}</td>
              <td>{{ s.requester }} ({{ s.requesterEmail }})</td>
              <td>{{ s.createdAt | date:'short' }}</td>
              <td>
                <button mat-stroked-button (click)="loadSavedIntoCurrent(s.id)">{{ 'ESTIMATION.LIST_LOAD' | translate }}</button>
                <button mat-stroked-button color="warn" (click)="deleteSavedEstimation(s.id)">{{ 'ESTIMATION.LIST_DELETE' | translate }}</button>
              </td>
            </tr>
          </tbody>
        </table>
      </div>
    </mat-tab>
  </mat-tab-group>
</div>
