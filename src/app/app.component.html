<app-spinner></app-spinner>

<mat-sidenav-container>

  <!-- ──────────────────────────────── -->
  <!--  MENÚ LATERAL                   -->
  <!-- ──────────────────────────────── -->
  <mat-sidenav mode="side" opened>
    <mat-toolbar color="primary" class="sidenav-toolbar">
      <img src="assets/images/7dRimV7.png" alt="JanusHub" class="janus" />
    </mat-toolbar>

    <mat-nav-list class="scroll-nat-nav-list">

      <ng-container *ngFor="let group of menuGroups">
        <div class="menu-group-header" (click)="toggleGroup(group.id)" role="button" tabindex="0">
            <span class="menu-group-title">{{ group.titleKey | translate }}</span>
          <mat-icon class="chev" [class.open]="isGroupOpen(group.id)">expand_more</mat-icon>
        </div>

        <div class="menu-group-items" *ngIf="isGroupOpen(group.id)">
          <!-- Bienvenida (sempre visible) -->
          <a *ngIf="group.items.includes('Bienvenida')" mat-list-item routerLink="/home">
            <mat-icon>home</mat-icon>
            <span class="menu-text"><strong>{{ 'MENU.WELCOME' | translate }}</strong></span>
          </a>

        <!-- Proyectos -->
        <a *ngIf="group.items.includes('Proyectos') && canShow('proyectos')" mat-list-item routerLink="/projects">
          <mat-icon>folder_open</mat-icon>
          <span class="menu-text"><strong>{{ 'MENU.PROJECTS' | translate }}</strong></span>
        </a>

        <!-- Scrum -->
        <a *ngIf="group.items.includes('Scrum')" mat-list-item routerLink="/scrum">
          <mat-icon>view_week</mat-icon>
          <span class="menu-text"><strong>{{ 'MENU.SCRUM' | translate }}</strong></span>
        </a>

        <!-- Estimación -->
        <a *ngIf="group.items.includes('Estimación')" mat-list-item routerLink="/estimacion">
          <mat-icon>timeline</mat-icon>
          <span class="menu-text"><strong>{{ 'MENU.ESTIMATION' | translate }}</strong></span>
        </a>

        <!-- Procedimientos -->
        <a *ngIf="group.items.includes('Procedimientos') && canShow('procedimientos')" mat-list-item routerLink="/procedimientos">
          <mat-icon>assignment</mat-icon>
          <span class="menu-text"><strong>{{ 'MENU.PROCEDURES' | translate }}</strong></span>
        </a>

        <!-- Bitácora -->
        <a *ngIf="group.items.includes('Bitácora') && canShow('bitacora')" mat-list-item routerLink="/bitacora">
          <mat-icon>bug_report</mat-icon>
          <span class="menu-text"><strong>{{ 'MENU.LOGBOOK' | translate }}</strong></span>
        </a>

        <!-- Infraestructura -->
        <a *ngIf="group.items.includes('Infraestructura') && canShow('infraestructura')" mat-list-item routerLink="/infraestructura">
          <mat-icon>storage</mat-icon>
          <span class="menu-text"><strong>{{ 'MENU.INFRASTRUCTURE' | translate }}</strong></span>
        </a>

        <!-- Herramientas -->
        <a *ngIf="group.items.includes('Herramientas') && canShow('herramientas')" mat-list-item routerLink="/herramientas">
          <mat-icon>build</mat-icon>
          <span class="menu-text"><strong>{{ 'MENU.TOOLS' | translate }}</strong></span>
        </a>

        <!-- Documentos -->
        <a *ngIf="group.items.includes('Documentos') && canShow('documentos')" mat-list-item routerLink="/documents">
          <mat-icon>upload_file</mat-icon>
          <span class="menu-text"><strong>{{ 'MENU.DOCUMENTS' | translate }}</strong></span>
        </a>

        <!-- Formación -->
        <a *ngIf="group.items.includes('Formación') && canShow('formacion')" mat-list-item routerLink="/formacion">
          <mat-icon>school</mat-icon>
          <span class="menu-text"><strong>{{ 'MENU.TRAINING' | translate }}</strong></span>
        </a>

        <!-- Planificación -->
        <a *ngIf="group.items.includes('Planificación') && canShow('planificacion')" mat-list-item routerLink="/planificacion">
          <mat-icon>event_note</mat-icon>
          <span class="menu-text"><strong>{{ 'MENU.PLANNING' | translate }}</strong></span>
        </a>

        <!-- Multimedia -->
        <a *ngIf="group.items.includes('Multimedia') && canShow('multimedia')" mat-list-item routerLink="/multimedia">
          <mat-icon>perm_media</mat-icon>
          <span class="menu-text"><strong>{{ 'MENU.MULTIMEDIA' | translate }}</strong></span>
        </a>

        <!-- Administración -->
        <a *ngIf="group.items.includes('Administración') && canShow('administracion')" mat-list-item routerLink="/administracion">
          <mat-icon>admin_panel_settings</mat-icon>
          <span class="menu-text"><strong>{{ 'MENU.ADMIN' | translate }}</strong></span>
        </a>

        <!-- Descargables (siempre visible, internacionalizado) -->
        <a *ngIf="group.items.includes('Descargables')" mat-list-item routerLink="/descargables">
          <mat-icon>download</mat-icon>
          <span class="menu-text"><strong>{{ 'MENU.DESCARGABLES' | translate }}</strong></span>
        </a>

        </div>

      </ng-container>

    </mat-nav-list>
  </mat-sidenav>

  <!-- ──────────────────────────────── -->
  <!--  CONTENIDO PRINCIPAL            -->
  <!-- ──────────────────────────────── -->
  <mat-sidenav-content>

    <!-- Clip helper persistente -->
    <div class="clip-helper" tabindex="0" title="Ayuda" (click)="toggleClip()"></div>

    <!-- Popup tipo 'habla' del clip -> chat AI -->
    <div class="clip-popup" *ngIf="clipOpen">
      <div class="clip-chat">
        <div class="clip-header">
          <strong>{{ 'CLIP.AI' | translate }}</strong>
        </div>

        <div class="messages" #messagesContainer>
          <div *ngFor="let m of aiMessages" class="message" [ngClass]="{user: m.from==='user', ai: m.from==='ai'}">
            <div class="msg-from"><strong>{{ m.from==='user' ? ('CLIP.USER' | translate) : ('CLIP.AI' | translate) }}</strong></div>
            <div class="msg-text">{{ m.text }}</div>
          </div>
        </div>

        <div class="clip-input-row">
          <textarea id="clip-input" class="clip-input" rows="3" title="clip"[(ngModel)]="userInput" (keydown.enter)="onEnter($event)" [placeholder]="('CLIP.PLACEHOLDER' | translate)"></textarea>
          <div class="clip-buttons">
            <button mat-flat-button color="primary" (click)="sendToAi()">{{ 'CLIP.SEND' | translate }}</button>
            <button mat-stroked-button (click)="speakLast()">{{ 'CLIP.SPEAK' | translate }}</button>
          </div>
        </div>
      </div>
    </div>


    <!-- Logos -->
    <div class="banner-imatges">
      <a href="https://git.intranet.gencat.cat/" target="_blank" rel="noopener noreferrer">
        <img src="assets/images/bknE50v.png" class="imatge-menu" title="Git Intranet Gencat" />
      </a>
      <a href="https://codi.qualitat.solucions.gencat.cat" target="_blank" rel="noopener noreferrer">
        <img src="assets/images/Zadx1Z5.png" class="imatge-menu" title="Codi Qualitat Solucions Gencat" />
      </a>
      <a href="https://bin.sic.intranet.gencat.cat/" target="_blank" rel="noopener noreferrer">
        <img src="assets/images/YTUL8j6.png" class="imatge-menu" title="BIN SIC Intranet Gencat" />
      </a>
      <a href="https://cicd.sic.intranet.gencat.cat/" target="_blank" rel="noopener noreferrer">
        <img src="assets/images/YDyH4j0.png" class="imatge-menu" title="CI/CD SIC Intranet Gencat" />
      </a>
      <a href="https://console-openshift-console.apps.cer01-gct-007-k01.cpd2pre.intranet.gencat.cat/dev-monitoring/"
        target="_blank" rel="noopener noreferrer">
        <img src="assets/images/rL2dIOn.png" class="imatge-menu" title="OpenShift Dev Monitoring PRE" />
      </a>
      <a href="https://console-openshift-console.apps.cer01-gct-008-k01.cpd2.intranet.gencat.cat/dev-monitoring/"
        target="_blank" rel="noopener noreferrer">
        <img src="assets/images/LMRdKym.png" class="imatge-menu" title="OpenShift Dev Monitoring PROD" />
      </a>
      <a href="https://bitbucket.indra.es/" target="_blank" rel="noopener noreferrer">
        <img src="assets/images/aLBxDxO.png" class="imatge-menu" title="Bitbucket Indra" />
      </a>
      <a href="https://qamindce.indra.es/" target="_blank" rel="noopener noreferrer">
        <img src="assets/images/0vFxwra.png" class="imatge-menu" title="QA Mindce Indra" />
      </a>
      <a href="https://slmaven.indra.es/nexus/#browse/browse" target="_blank" rel="noopener noreferrer">
        <img src="assets/images/ZOQXBuY.png" class="imatge-menu" title="Nexus SLMaven" />
      </a>
      <a href="https://console-openshift-console.apps-crc.testing/k8s/ns/ms-crc-dev-env/" target="_blank"
        rel="noopener noreferrer">
        <img src="assets/images/swGo7Aa.png" class="imatge-menu" title="OpenShift CRC Dev" />
      </a>
      <a href="https://console-openshift-console.apps-crc.testing/k8s/ns/ms-crc-int-env/" target="_blank"
        rel="noopener noreferrer">
        <img src="assets/images/dhXgpv5.png" class="imatge-menu" title="OpenShift CRC Int" />
      </a>

      <!-- Jenkins -->
      <a routerLink="/jenkins">
        <img src="assets/images/69aimFa.png" class="imatge-menu imatge-menu-jenkins" title="Jenkins" />
      </a>
    </div>

    <!-- ──────────────────────────────── -->
    <!--  TOOLBAR SUPERIOR               -->
    <!-- ──────────────────────────────── -->
    <mat-toolbar color="primary" class="main-toolbar">
      <span class="app-title">JanusHub Portal</span>
      <span class="spacer"></span>
      
      <!-- Botones de idioma -->
      <div class="lang-buttons">
        <button 
          class="lang-btn" 
          [class.active]="translate.currentLang === 'es'"
          (click)="translateLanguage('es')">
          ES
        </button>
        <button 
          class="lang-btn" 
          [class.active]="translate.currentLang === 'ca'"
          (click)="translateLanguage('ca')">
          CA
        </button>
        <button 
          class="lang-btn" 
          [class.active]="translate.currentLang === 'en'"
          (click)="translateLanguage('en')">
          EN
        </button>
      </div>

      <!-- ICONA ÚNICA -->
      <div class="user-dropdown-container">
        <div class="user-icon" (click)="username ? userMenuOpen = !userMenuOpen : openLoginDialog()">
          <mat-icon>person</mat-icon>
        </div>

        <!-- Menú només si hi ha usuari -->
        <div class="dropdown-user-menu" *ngIf="userMenuOpen && username">
          <p>{{ 'USER.USERNAME' | translate }}: <strong>{{ username }}</strong></p>
          <strong>{{rol}}</strong>

          <!-- AFEGEIX AQUI el botó de secció usuari -->
          <button mat-button (click)="abrirSeccionUsuario()">
            <mat-icon>manage_accounts</mat-icon> {{ 'USER.PROFILE' | translate }}
          </button>

          <button mat-button color="warn" (click)="logout()">
            <mat-icon>logout</mat-icon> {{ 'USER.LOGOUT' | translate }}
          </button>
        </div>
      </div>
    </mat-toolbar>

    <!-- CONTENIDO INTERIOR -->
    <div class="main-content menu-content-scroll">
      <router-outlet></router-outlet>
    </div>



    <!-- FOOTER -->
    <footer class="footer">
      <span>{{ 'FOOTER.COPYRIGHT' | translate }} |
        <strong>{{ appVersion ?? 'obteniendo versión...' }}</strong>
      </span>
    </footer>
  </mat-sidenav-content>
</mat-sidenav-container>