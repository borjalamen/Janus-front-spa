<app-buscador (buscar)="filtrar($event)"></app-buscador>

<div class="procedures-section">
  <div class="procedures-header">
    <h2>{{ 'PROCEDURES_SECTION.TITLE' | translate }}</h2>
  </div>

  <!-- Pestanyes -->
  <div class="procedures-tabs">
    <button class="procedures-tab" [class.active]="activeTab==='crear'" (click)="obrirPopupCrear()">
      <mat-icon inline="true">add</mat-icon>
      {{ 'PROCEDURES_SECTION.TAB_CREATE' | translate }}
    </button>
    <button class="procedures-tab" [class.active]="activeTab==='listar'" (click)="activeTab='listar'">
      <mat-icon inline="true">list</mat-icon>
      {{ 'PROCEDURES_SECTION.TAB_LIST' | translate }}
    </button>
  </div>

  <!-- Pestanya: Crear/Editar -->
  <div *ngIf="activeTab==='crear'" class="procedures-tab-panel">
    <div class="procedure-form">
      <h3>
        {{ modoForm === 'editar'
            ? ('PROCEDURES_SECTION.EDIT_TITLE' | translate)
            : ('PROCEDURES_SECTION.NEW_TITLE'  | translate) }}
      </h3>

      <div class="procedure-field">
        <label>{{ 'PROCEDURES_SECTION.FIELD_TITLE' | translate }}</label>
        <input
          type="text"
          [(ngModel)]="procForm.titulo"
          [placeholder]="'PROCEDURES_SECTION.PLACEHOLDER_TITLE' | translate"
          title="T√≠tol del procediment" />
      </div>

      <div class="procedure-field">
        <label>{{ 'PROCEDURES_SECTION.FIELD_DEPARTMENT' | translate }}</label>
        <input
          type="text"
          [(ngModel)]="procForm.departamento"
          [placeholder]="'PROCEDURES_SECTION.PLACEHOLDER_DEPARTMENT' | translate"
          title="Departament (ex: Facturaci√≥, Suport...)" />
      </div>

      <!-- Entorn amb botons i preview -->
      <div class="procedure-field">
        <label>Entorn</label>
        <div class="entorno-botones-wrapper">
          <button
            type="button"
            class="entorno-btn"
            [class.active]="procForm.entorno === 'minsait'"
            (click)="procForm.entorno = 'minsait'"
            [style.--color]="'#1E88E5'"
            title="Minsait">
            Minsait
          </button>
          <button
            type="button"
            class="entorno-btn"
            [class.active]="procForm.entorno === 'preproduccion'"
            (click)="procForm.entorno = 'preproduccion'"
            [style.--color]="'#FBC02D'"
            title="Preproducci√≥">
            Preproducci√≥
          </button>
          <button
            type="button"
            class="entorno-btn"
            [class.active]="procForm.entorno === 'produccion'"
            (click)="procForm.entorno = 'produccion'"
            [style.--color]="'#E53935'"
            title="Producci√≥">
            Producci√≥
          </button>

          <!-- Preview cub entorn -->
          <div
            class="entorno-icon-preview"
            [style.background]="'linear-gradient(135deg, '
              + getColorEntorno(procForm.entorno || '')
              + ', '
              + getColorEntorno(procForm.entorno || '')
              + 'cc)'">
            <span class="procedure-icon-number">
              {{ getNumeroDepartamento(procForm.entorno || '') }}
            </span>
          </div>
        </div>
      </div>

      <div class="procedure-field">
        <label>{{ 'PROCEDURES_SECTION.FIELD_RESPONSIBLE' | translate }}</label>
        <input
          type="text"
          [(ngModel)]="primerResponsable"
          [placeholder]="'PROCEDURES_SECTION.PLACEHOLDER_RESPONSIBLE' | translate"
          title="Responsable principal" />
      </div>

      <div class="procedure-field">
        <label>{{ 'PROCEDURES_SECTION.FIELD_DESCRIPTION' | translate }}</label>
        <textarea
          rows="3"
          [(ngModel)]="procForm.descripcion"
          [placeholder]="'PROCEDURES_SECTION.PLACEHOLDER_DESCRIPTION' | translate"
          title="Descripci√≥ del procediment">
        </textarea>
      </div>

      <!-- Editor m√∫ltiples steps -->
      <div class="procedure-field">
        <label>{{ 'PROCEDURES_SECTION.FIELD_STEPS' | translate }}</label>
        <div class="procedure-steps-container">
          <button
            type="button"
            class="procedure-add-step-btn"
            (click)="afegirStep()"
            title="Afegir step">
            <mat-icon>add</mat-icon>
          </button>

          <div *ngIf="!procForm.steps || procForm.steps.length === 0" class="procedure-no-steps">
            <p>{{ 'PROCEDURES_SECTION.NO_STEPS' | translate }}</p>
          </div>

          <div *ngFor="let s of procForm.steps; let i = index" class="procedure-step-edit-item">
            <div class="procedure-step-edit-header">
              <span class="procedure-step-edit-number">Step {{ i + 1 }}</span>
              <button
                type="button"
                class="procedure-step-delete-btn"
                (click)="eliminarStep(i)"
                title="Eliminar step">
                <mat-icon>close</mat-icon>
              </button>
            </div>

            <input
              type="text"
              [(ngModel)]="s.titulo"
              placeholder="T√≠tol del step"
              class="procedure-step-edit-input" />

            <input
              type="text"
              [(ngModel)]="s.responsable"
              placeholder="Responsable"
              class="procedure-step-edit-input" />

            <textarea
              rows="2"
              [(ngModel)]="s.descripcion"
              placeholder="Descripci√≥ del step"
              class="procedure-step-edit-textarea">
            </textarea>
          </div>
        </div>
      </div>

      <div class="procedure-form-actions">
        <button class="procedure-cancel-btn" (click)="tancarPopup()" title="Cancel¬∑lar">
          ‚úó
        </button>
        <button
          class="procedure-save-btn"
          (click)="guardarProcedimiento()"
          [title]="modoForm === 'editar' ? 'Actualitzar' : 'Crear'">
          {{ modoForm === 'editar' ? '‚úé' : '‚úì' }}
        </button>
      </div>
    </div>
  </div>

  <!-- Pestanya: Llistar -->
  <div *ngIf="activeTab==='listar'" class="procedures-tab-panel">
    <p class="procedures-description">
      {{ 'PROCEDURES_SECTION.DESCRIPTION' | translate }}
    </p>

    <div class="procedures-list" *ngIf="procedimientosFiltrados.length > 0">
      <div *ngFor="let p of procedimientosFiltrados" class="procedure-row">
        <!-- Cub d'entorn amb n√∫mero -->
        <div
          class="procedure-icon"
          *ngIf="p.entorno"
          [style.background]="'linear-gradient(135deg, '
            + getColorEntorno(p.entorno || '') 
            + ', ' 
            + getColorEntorno(p.entorno || '') 
            + 'cc)'">
          <span class="procedure-icon-number">
            {{ getNumeroDepartamento(p.entorno || '') }}
          </span>
        </div>

        <div class="procedure-info">
          <div class="procedure-title-row">
            <strong class="procedure-title">
              {{ p.titulo || '(Sense t√≠tol)' }}
            </strong>

            <span class="procedure-dept-pill" *ngIf="p.departamento" >
              {{ p.departamento }}
            </span>

            <!-- Data tipus bit√†cola, al costat del t√≠tol -->
            <span class="procedure-fecha-pill" *ngIf="p.createdAt">
              {{ p.createdAt }}
            </span>

            <!-- Badge entorn -->
            <span
              class="procedure-chip"
              *ngIf="p.entorno"
              [style.backgroundColor]="getColorEntorno(p.entorno || '') + '33'"
              [style.borderColor]="getColorEntorno(p.entorno || '')">
              <span class="procedure-chip-number">
                {{ getNumeroDepartamento(p.entorno || '') }}
              </span>
              <span class="procedure-chip-text">
                {{ getNombreEntorno(p.entorno || '') }}
              </span>
            </span>

            
          </div>

          <div class="procedure-text" *ngIf="p.descripcion">
            {{ p.descripcion }}
          </div>

          <div class="procedure-steps-summary" *ngIf="p.steps && p.steps.length > 0">
            <div class="procedure-steps-summary-item">
              <mat-icon class="procedure-steps-icon">assignment</mat-icon>
              <div class="procedure-steps-summary-text">
                <strong>
                  {{ 'PROCEDURES_SECTION.RESPONSIBLE' | translate }}:
                  {{ p.steps[0]?.responsable || '-' }}
                </strong>
                <p>
                  {{ 'PROCEDURES_SECTION.STEPS_COUNT' | translate:{count: p.steps.length} }}
                </p>
              </div>
            </div>
          </div>

          <div class="procedure-actions">
            <button
              class="procedure-action-btn procedure-view-btn"
              (click)="verSteps(p)"
              title="Veure steps"
              *ngIf="p.steps && p.steps.length > 0">
              <mat-icon>visibility</mat-icon>
            </button>
            <button
              class="procedure-action-btn procedure-edit-btn"
              (click)="obrirPopupEditar(p)"
              title="Editar">
              ‚úèÔ∏è
            </button>
            <button
              class="procedure-action-btn procedure-delete-btn"
              (click)="confirmarEliminar(p)"
              title="Eliminar">
              üóëÔ∏è
            </button>
          </div>
        </div>
      </div>
    </div>

    <div *ngIf="procedimientosFiltrados.length === 0" class="procedures-no-results">
      <mat-icon>search_off</mat-icon>
      <p>{{ 'PROCEDURES_SECTION.NO_RESULTS' | translate }}</p>
    </div>
  </div>
</div>

<!-- Popup veure steps (carrusel) -->
<div class="procedures-popup-backdrop" *ngIf="mostrarSteps" (click)="tancarSteps()">
  <div class="procedures-popup" (click)="$event.stopPropagation()">
    <h3>
      {{ 'PROCEDURES_SECTION.STEPS_TITLE' | translate }}:
      {{ procSeleccionada?.titulo }}
    </h3>

    <div *ngIf="!procSeleccionada?.steps?.length">
      {{ 'PROCEDURES_SECTION.NO_STEPS' | translate }}
    </div>

    <div *ngIf="procSeleccionada?.steps?.length" class="procedure-step-carousel">
      <button class="procedure-step-nav-btn" (click)="prevStep()" title="Step anterior">
        <mat-icon>chevron_left</mat-icon>
      </button>

      <div class="procedure-step-item">
        <div class="procedure-step-header">
          <div class="procedure-step-title">
            <strong>
              Step {{ currentStepIndex + 1 }} -
              {{ procSeleccionada?.steps?.[currentStepIndex]?.titulo }}
            </strong>
          </div>
        </div>
        <div class="procedure-step-content">
          <div>
            <b>{{ 'PROCEDURES_SECTION.RESPONSIBLE' | translate }}:</b>
            {{ procSeleccionada?.steps?.[currentStepIndex]?.responsable }}
          </div>
          <div *ngIf="procSeleccionada?.steps?.[currentStepIndex]?.descripcion">
            {{ procSeleccionada?.steps?.[currentStepIndex]?.descripcion }}
          </div>
        </div>
      </div>

      <button class="procedure-step-nav-btn" (click)="nextStep()" title="Step seg√ºent">
        <mat-icon>chevron_right</mat-icon>
      </button>
    </div>

    <div class="procedures-popup-actions">
      <button class="procedure-cancel-btn" (click)="tancarSteps()" title="Tancar">
        ‚úó
      </button>
    </div>
  </div>
</div>

<!-- Popup eliminar -->
<div class="procedures-popup-backdrop" *ngIf="mostrarPopupDelete" (click)="cancelarEliminar()">
  <div class="procedures-popup" (click)="$event.stopPropagation()">
    <h3>{{ 'PROCEDURES_SECTION.DELETE_TITLE' | translate }}</h3>
    <p>
      {{ 'PROCEDURES_SECTION.DELETE_CONFIRM' | translate:{
        title: (procAEliminar && procAEliminar.titulo) || '(Sense t√≠tol)'
      } }}
    </p>

    <div class="procedures-popup-actions">
      <button class="procedure-cancel-btn" (click)="cancelarEliminar()" title="Cancelar">
        ‚úó
      </button>
      <button class="procedure-save-btn" (click)="eliminarProcedimiento()" title="Eliminar">
        ‚úì
      </button>
    </div>
  </div>
</div>
