<app-buscador (buscar)="filtrar($event)"></app-buscador>

<div class="procedures-section">
  <div class="procedures-header">
    <h2>{{ 'PROCEDURES_SECTION.TITLE' | translate }}</h2>
  </div>

  <!-- Pestanyes -->
  <div class="procedures-tabs">
    <button class="procedures-tab" [class.active]="activeTab==='crear'" (click)="obrirPopupCrear()">
      <mat-icon inline="true">add</mat-icon>
      {{ 'PROCEDURES_SECTION.TAB_CREATE' | translate }}
    </button>
    <button class="procedures-tab" [class.active]="activeTab==='listar'" (click)="activeTab='listar'">
      <mat-icon inline="true">list</mat-icon>
      {{ 'PROCEDURES_SECTION.TAB_LIST' | translate }}
    </button>
  </div>

  <!-- Pestanya: Crear/Editar -->
  <div *ngIf="activeTab==='crear'" class="procedures-tab-panel">
    <div class="procedure-form">
      <div class="procedure-form-header">
        <div class="procedure-form-title">
          <h3>
            {{ modoForm === 'editar'
              ? ('PROCEDURES_SECTION.EDIT_TITLE' | translate)
              : ('PROCEDURES_SECTION.NEW_TITLE' | translate) }}
          </h3>
          <span class="procedure-form-mode-pill">
            {{ modoForm === 'editar'
              ? ('PROCEDURES_SECTION.MODE_EDIT' | translate)
              : ('PROCEDURES_SECTION.MODE_CREATE' | translate) }}
          </span>
        </div>
      </div>

      <div class="procedure-field-grid">
        <div class="procedure-field">
          <label>{{ 'PROCEDURES_SECTION.FIELD_TITLE' | translate }}</label>
          <input
            type="text"
            [(ngModel)]="procForm.titulo"
            [placeholder]="'PROCEDURES_SECTION.PLACEHOLDER_TITLE' | translate"
            title="T√≠tol del procediment" />
        </div>
      </div>

      <div class="procedure-field">
        <label>{{ 'PROCEDURES_SECTION.FIELD_DESCRIPTION' | translate }}</label>
        <textarea
          rows="3"
          [(ngModel)]="procForm.descripcion"
          [placeholder]="'PROCEDURES_SECTION.PLACEHOLDER_DESCRIPTION' | translate"
          title="Descripci√≥ del procediment">
        </textarea>
      </div>

      <!-- Tags procediment -->
      <div class="procedure-field">
        <label>{{ 'PROCEDURES_SECTION.FIELD_TAGS' | translate }}</label>
        <input
          type="text"
          [ngModel]="procForm.tags?.join(', ')"
          (ngModelChange)="onProcTagsChange($event)"
          placeholder="tag1, tag2, tag3"
          class="procedure-step-edit-input" />
      </div>

      <!-- Editor m√∫ltiples steps -->
      <div class="procedure-field">
        <div class="procedure-steps-header">
          <label>{{ 'PROCEDURES_SECTION.FIELD_STEPS' | translate }}</label>
          <button type="button" class="procedure-add-step-btn" (click)="afegirStep()" title="Afegir step">
            <mat-icon>add</mat-icon>
            {{ 'PROCEDURES_SECTION.ADD_STEP' | translate }}
          </button>
        </div>

        <div class="procedure-steps-container">
          <div *ngIf="!procForm.steps || procForm.steps.length === 0" class="procedure-no-steps">
            <mat-icon>lightbulb_outline</mat-icon>
            <p>{{ 'PROCEDURES_SECTION.NO_STEPS' | translate }}</p>
          </div>

          <div *ngFor="let s of procForm.steps; let i = index" class="procedure-step-edit-item">
            <div class="procedure-step-edit-header">
              <div class="procedure-step-edit-left">
                <span class="procedure-step-edit-number">
                  #{{ i + 1 }}
                </span>
                <div
                  class="procedure-step-env-cube"
                  [style.background]="'linear-gradient(135deg, '
                    + getColorEntorno(s.entorno || '') + ', '
                    + getColorEntorno(s.entorno || '') + 'cc)'">
                  <span class="procedure-step-env-number">
                    {{ i + 1 }}
                  </span>
                </div>
              </div>

              <div class="procedure-step-env-buttons">
                <button
                  type="button"
                  class="entorno-btn"
                  [class.active]="s.entorno === 'minsait'"
                  (click)="s.entorno = 'minsait'"
                  [style.--color]="'#1E88E5'">
                  M
                </button>
                <button
                  type="button"
                  class="entorno-btn"
                  [class.active]="s.entorno === 'preproduccion'"
                  (click)="s.entorno = 'preproduccion'"
                  [style.--color]="'#FBC02D'">
                  PRE
                </button>
                <button
                  type="button"
                  class="entorno-btn"
                  [class.active]="s.entorno === 'produccion'"
                  (click)="s.entorno = 'produccion'"
                  [style.--color]="'#E53935'">
                  PROD
                </button>
              </div>

              <button
                type="button"
                class="procedure-step-delete-btn"
                (click)="eliminarStep(i)"
                title="Eliminar step">
                <mat-icon>close</mat-icon>
              </button>
            </div>

            <!-- T√≠tol + responsable -->
            <div class="procedure-step-edit-grid">
              <input
                type="text"
                [(ngModel)]="s.titulo"
                placeholder=""
                class="procedure-step-edit-input" />

              <input
                type="text"
                [(ngModel)]="s.responsable"
                placeholder="Responsable"
                class="procedure-step-edit-input" />
            </div>

            <!-- Tags step -->
            <div class="procedure-step-edit-grid">
              <input
                type="text"
                [ngModel]="s.tags?.join(', ')"
                (ngModelChange)="onStepTagsChange($event, i)"
                placeholder="tags del step, separats per comes"
                class="procedure-step-edit-input" />
            </div>

            <!-- Imatge step: URL + arxiu -->
            <div class="procedure-step-image-field">
              <label>Imatge del step</label>
              <div class="procedure-step-image-row">
                <!-- URL directa (opcional) -->
                <input
                  type="text"
                  [(ngModel)]="s.imageUrl"
                  placeholder="URL (opcional)"
                  class="procedure-step-edit-input" />

                <!-- Input ocult per triar arxiu (un per step) -->
                <input
                  #fileInput
                  type="file"
                  accept="image/*"
                  (change)="onStepImageSelected($event, i)"
                  style="display: none" />

                <!-- Bot√≥ icona carpeta que dispara el click del file input -->
                <button
                  type="button"
                  class="file-icon-btn"
                  (click)="onClickFileIcon(fileInput)">
                  <mat-icon>folder</mat-icon>
                </button>

                <div class="procedure-step-image-thumb" *ngIf="s.imageUrl">
                  <img
                    [src]="s.imageUrl"
                    alt="Imatge step {{ i + 1 }}"
                    (click)="obrirImatgeNovaFinestra(s.imageUrl)" />
                </div>
              </div>
            </div>

            <textarea
              rows="2"
              [(ngModel)]="s.descripcion"
              placeholder="Descripci√≥ del step"
              class="procedure-step-edit-textarea">
            </textarea>
          </div>
        </div>
      </div>

      <div class="procedure-form-actions">
        <button class="procedure-cancel-btn" (click)="tancarPopup()" title="Cancel¬∑lar">
          ‚úó
        </button>
        <button
          class="procedure-save-btn"
          (click)="guardarProcedimiento()"
          [title]="modoForm === 'editar' ? 'Actualitzar' : 'Crear'">
          {{ modoForm === 'editar' ? '‚úé' : '‚úì' }}
        </button>
      </div>
    </div>
  </div>

  <!-- Pestanya: Llistar -->
  <div *ngIf="activeTab==='listar'" class="procedures-tab-panel">

    <!-- MODE LLISTAT -->
    <ng-container *ngIf="!mostrarDetallSteps; else detallStepsTpl">
      <p class="procedures-description">
        {{ 'PROCEDURES_SECTION.DESCRIPTION' | translate }}
      </p>

      <div class="procedures-list" *ngIf="procedimientosFiltrados.length > 0">
        <div *ngFor="let p of procedimientosFiltrados" class="procedure-row">
          <!-- Cub entorn procediment -->
          <div
            class="procedure-icon"
            *ngIf="p.entorno"
            [style.background]="'radial-gradient(circle at 20% 20%, '
              + getColorEntorno(p.entorno || '') + ', #000)'">
            <span class="procedure-icon-number">
              {{ getNumeroDepartamento(p.entorno || '') }}
            </span>
          </div>

          <div class="procedure-info">
            <div class="procedure-title-row">
              <strong class="procedure-title">
                {{ p.titulo || '(Sense t√≠tol)' }}
              </strong>

              <span class="procedure-fecha-pill" *ngIf="p.createdAt">
                {{ p.createdAt }}
              </span>

              <span
                class="procedure-chip"
                *ngIf="p.entorno"
                [style.backgroundColor]="getColorEntorno(p.entorno || '') + '33'"
                [style.borderColor]="getColorEntorno(p.entorno || '')">
                <span class="procedure-chip-number">
                  {{ getNumeroDepartamento(p.entorno || '') }}
                </span>
                <span class="procedure-chip-text">
                  {{ getNombreEntorno(p.entorno || '') }}
                </span>
              </span>
            </div>

            <div class="procedure-text" *ngIf="p.descripcion">
              {{ p.descripcion }}
            </div>

            <!-- Tags del procediment al llistat -->
            <div class="procedure-tags" *ngIf="p.tags && p.tags.length > 0">
              <span class="tag-pill" *ngFor="let tag of p.tags">
                {{ tag }}
              </span>
            </div>

            <div class="procedure-steps-summary" *ngIf="p.steps && p.steps.length > 0">
              <div class="procedure-steps-summary-item">
                <mat-icon class="procedure-steps-icon">assignment</mat-icon>
                <div class="procedure-steps-summary-text">
                  <strong>
                    {{ 'PROCEDURES_SECTION.RESPONSIBLE' | translate }}:
                    {{ p.steps[0]?.responsable || '-' }}
                  </strong>
                  <p>
                    {{ 'PROCEDURES_SECTION.STEPS_COUNT' | translate:{count: p.steps.length} }}
                  </p>
                </div>
              </div>
            </div>

            <div class="procedure-actions">
              <button
                class="procedure-action-btn procedure-view-btn"
                (click)="verSteps(p)"
                title="Veure steps"
                *ngIf="p.steps && p.steps.length > 0">
                <mat-icon>visibility</mat-icon>
              </button>
              <button
                class="procedure-action-btn procedure-edit-btn"
                (click)="obrirPopupEditar(p)"
                title="Editar">
                ‚úèÔ∏è
              </button>
              <button
                class="procedure-action-btn procedure-delete-btn"
                (click)="confirmarEliminar(p)"
                title="Eliminar">
                üóëÔ∏è
              </button>
            </div>
          </div>
        </div>
      </div>

      <div *ngIf="procedimientosFiltrados.length === 0" class="procedures-no-results">
        <mat-icon>search_off</mat-icon>
        <p>{{ 'PROCEDURES_SECTION.NO_RESULTS' | translate }}</p>
      </div>
    </ng-container>

    <!-- MODE DETALL STEPS (mateixa vista) -->
    <ng-template #detallStepsTpl>
      <div class="procedure-steps-detail-container" *ngIf="procDetall">

        <!-- Header: t√≠tol + data + entorn -->
        <div class="procedure-steps-detail-header">
          <button class="procedure-detail-back-btn" (click)="tancarDetallSteps()" title="Tornar">
            <mat-icon>arrow_back</mat-icon>
          </button>

          <div class="procedure-steps-detail-title">
            <div class="procedure-steps-detail-title-row">
              <h3>{{ procDetall.titulo || '(Sense t√≠tol)' }}</h3>

              <span class="procedure-fecha-pill" *ngIf="procDetall.createdAt">
                {{ procDetall.createdAt }}
              </span>
              <span class="tag-pill" *ngFor="let tag of procDetall.tags">
            {{ tag }}
          </span>

              <span
                class="procedure-chip"
                *ngIf="procDetall.entorno"
                [style.backgroundColor]="getColorEntorno(procDetall.entorno || '') + '33'"
                [style.borderColor]="getColorEntorno(procDetall.entorno || '')">
                <span class="procedure-chip-number">
                  {{ getNumeroDepartamento(procDetall.entorno || '') }}
                </span>
                <span class="procedure-chip-text">
                  {{ getNombreEntorno(procDetall.entorno || '') }}
                </span>
              </span>
            </div>

            <p class="procedure-steps-detail-sub">
              {{ procDetall.descripcion }}
            </p>
          </div>
        </div>

        <!-- Tags del procediment al detall 
        <div class="procedure-tags" *ngIf="procDetall.tags && procDetall.tags.length > 0">
          <span class="tag-pill" *ngFor="let tag of procDetall.tags">
            {{ tag }}
          </span>
        </div>-->

        <!-- Carrusel de steps -->
        <div class="procedure-steps-carousel" *ngIf="procDetall.steps && procDetall.steps.length > 0">
          <div class="procedure-steps-carousel-wrapper">
            <!-- Fletxa ESQUERRA -->
            <button class="carousel-arrow left" (click)="prevStep()" [disabled]="currentStepIndex === 0">
              <mat-icon>chevron_left</mat-icon>
            </button>

            <!-- Step central amb animaci√≥ -->
            <div class="procedure-step-slide" [ngClass]="slideDirection">
              <ng-container *ngIf="procDetall.steps[currentStepIndex] as s; else noStep">
                <div class="procedure-step-detail-item">
                  <div class="procedure-step-detail-header">
                    <div
                      class="procedure-step-env-cube"
                      [style.background]="'linear-gradient(135deg, '
                        + getColorEntorno(s.entorno || '') + ', '
                        + getColorEntorno(s.entorno || '') + 'cc)'">
                      <span class="procedure-step-env-number">
                        {{ currentStepIndex + 1 }}
                      </span>
                    </div>
                    <div class="procedure-step-detail-title">
                      <strong>
                        <ng-container *ngIf="s.titulo; else fallbackTitle">
                          {{ s.titulo }} - {{ currentStepIndex + 1 }}
                        </ng-container>
                        <ng-template #fallbackTitle>
                          {{ procDetall.titulo || '(Sense t√≠tol)' }} - {{ currentStepIndex + 1 }}
                        </ng-template>
                      </strong>
                      <span class="procedure-step-detail-resp">
                        {{ 'PROCEDURES_SECTION.RESPONSIBLE' | translate }}:
                        {{ s.responsable || '-' }}
                      </span>
                    </div>
                  </div>

                  <!-- Tags del step al detall -->
                  <div class="procedure-step-tags" *ngIf="s.tags && s.tags.length > 0">
                    <span class="tag-pill" *ngFor="let tag of s.tags">
                      {{ tag }}
                    </span>
                  </div>

                  <div class="procedure-step-detail-body">
                    <div class="procedure-step-detail-text" *ngIf="s.descripcion">
                      {{ s.descripcion }}
                    </div>

                    <div
                      class="procedure-step-detail-image"
                      [ngClass]="{'procedure-step-detail-image--full': !s.descripcion}">
                      <img
                        *ngIf="s.imageUrl"
                        [src]="s.imageUrl"
                        alt="Imatge step {{ currentStepIndex + 1 }}"
                        (click)="obrirImatgeNovaFinestra(s.imageUrl)" />
                    </div>
                  </div>
                </div>
              </ng-container>
              <ng-template #noStep>
                <p>No hi ha steps disponibles.</p>
              </ng-template>
            </div>

            <!-- Fletxa DRETA -->
            <button
              class="carousel-arrow right"
              (click)="nextStep()"
              [disabled]="procDetall.steps && currentStepIndex === procDetall.steps.length - 1">
              <mat-icon>chevron_right</mat-icon>
            </button>
          </div>

          <!-- Indicadors -->
          <div class="carousel-indicators">
            <span
              *ngFor="let s of procDetall.steps; let i = index"
              [class.active]="i === currentStepIndex"
              (click)="currentStepIndex = i">
            </span>
          </div>
        </div>

        <div *ngIf="!procDetall.steps || procDetall.steps.length === 0" class="procedures-no-results">
          <mat-icon>lightbulb_outline</mat-icon>
          <p>{{ 'PROCEDURES_SECTION.NO_STEPS' | translate }}</p>
        </div>
      </div>
    </ng-template>
  </div>
</div>

<!-- Popup eliminar -->
<div class="procedures-popup-backdrop" *ngIf="mostrarPopupDelete" (click)="cancelarEliminar()">
  <div class="procedures-popup" (click)="$event.stopPropagation()">
    <h3>{{ 'PROCEDURES_SECTION.DELETE_TITLE' | translate }}</h3>
    <p>
      {{ 'PROCEDURES_SECTION.DELETE_CONFIRM' | translate:{
        title: (procAEliminar && procAEliminar.titulo) || '(Sense t√≠tol)'
      } }}
    </p>

    <div class="procedures-popup-actions">
      <button class="procedure-cancel-btn" (click)="cancelarEliminar()" title="Cancelar">
        ‚úó
      </button>
      <button class="procedure-save-btn" (click)="eliminarProcedimiento()" title="Eliminar">
        ‚úì
      </button>
    </div>
  </div>
</div>
