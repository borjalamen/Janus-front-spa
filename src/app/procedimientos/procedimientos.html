<app-buscador (buscar)="filtrar($event)"></app-buscador>

<div class="section-container">
  <div class="documents-header">
    <h2>{{ 'PROCEDURES_SECTION.TITLE' | translate }}</h2>

    <button
      class="jenkins-add-btn"
      *ngIf="canEdit"
      (click)="obrirPopupCrear()">
      <mat-icon inline="true">add</mat-icon>
      <span>{{ 'PROCEDURES_SECTION.ADD_BUTTON' | translate }}</span>
    </button>
  </div>

  <p>{{ 'PROCEDURES_SECTION.DESCRIPTION' | translate }}</p>

  <!-- Llista de procediments com a cards -->
  <div class="procedures-grid">
    <div *ngFor="let p of procedimientosFiltrados" class="procedure-card">

      <!-- cap√ßalera del bloc -->
      <div class="procedure-header">
        <h3 class="procedure-name">
          {{ p.titulo || '(Sense t√≠tol)' }}
        </h3>

        <span class="procedure-status">
          {{ 'PROCEDURES_SECTION.STATUS' | translate }}:
          {{ p.departamento || '-' }}
        </span>
      </div>

      <!-- cos del bloc -->
      <div class="procedure-responsible">
        {{ 'PROCEDURES_SECTION.RESPONSIBLE' | translate }}:
        {{ (p.steps && p.steps[0] && p.steps[0].responsable) || '-' }}
      </div>

      <p class="procedure-desc" *ngIf="p.descripcion">
        {{ p.descripcion }}
      </p>

      <!-- Bot√≥ per veure els steps -->
      <div class="procedure-steps">
        <button
          class="jenkins-add-btn"
          (click)="verSteps(p)"
          title="Veure steps">
          üìã {{ 'PROCEDURES_SECTION.VIEW_STEPS' | translate }}
        </button>
      </div>

      <!-- accions CRUD a la dreta -->
      <div class="procedure-actions" *ngIf="canEdit">
        <button
          class="jenkins-add-btn"
          (click)="obrirPopupEditar(p)"
          title="Editar procedimiento">
          ‚úèÔ∏è
        </button>
        <button
          class="jenkins-add-btn cancel-btn"
          (click)="confirmarEliminar(p)"
          title="Eliminar procedimiento">
          üóëÔ∏è
        </button>
      </div>

    </div>
  </div>
</div>

<!-- Popup crear / editar -->
<div class="popup-fons" *ngIf="mostrarPopup" (click)="tancarPopup()">
  <div class="popup-container" (click)="$event.stopPropagation()">
    <h3>{{ (editando ? 'PROCEDURES_SECTION.EDIT_TITLE' : 'PROCEDURES_SECTION.NEW_TITLE') | translate }}</h3>

    <div class="form-field">
      <label>{{ 'PROCEDURES_SECTION.FIELD_TITLE' | translate }}</label>
      <input
        type="text"
        [(ngModel)]="procForm.titulo"
        [placeholder]="'PROCEDURES_SECTION.PLACEHOLDER_TITLE' | translate"
        title="T√≠tulo del procedimiento" />
    </div>

    <div class="form-field">
      <label>{{ 'PROCEDURES_SECTION.FIELD_DEPARTMENT' | translate }}</label>
      <input
        type="text"
        [(ngModel)]="procForm.departamento"
        [placeholder]="'PROCEDURES_SECTION.PLACEHOLDER_DEPARTMENT' | translate"
        title="Departamento / Estado" />
    </div>

    <div class="form-field">
      <label>{{ 'PROCEDURES_SECTION.FIELD_RESPONSIBLE' | translate }}</label>
      <input
        type="text"
        [(ngModel)]="primerResponsable"
        [placeholder]="'PROCEDURES_SECTION.PLACEHOLDER_RESPONSIBLE' | translate"
        title="Responsable principal" />
    </div>

    <div class="form-field">
      <label>{{ 'PROCEDURES_SECTION.FIELD_DESCRIPTION' | translate }}</label>
      <textarea
        rows="3"
        [(ngModel)]="procForm.descripcion"
        [placeholder]="'PROCEDURES_SECTION.PLACEHOLDER_DESCRIPTION' | translate"
        title="Descripci√≥n del procedimiento">
      </textarea>
    </div>

    <div class="popup-actions">
      <button class="cancelar-btn" (click)="tancarPopup()" title="Cancelar">
        ‚úó
      </button>
      <button class="guardar-btn" (click)="guardarProcedimiento()" [title]="editando ? 'Actualizar' : 'Guardar'">
        ‚úì
      </button>
    </div>
  </div>
</div>

<!-- Popup eliminar -->
<div class="popup-fons" *ngIf="mostrarPopupDelete" (click)="cancelarEliminar()">
  <div class="popup-container" (click)="$event.stopPropagation()">
    <h3>{{ 'PROCEDURES_SECTION.DELETE_TITLE' | translate }}</h3>
    <p>
      {{ 'PROCEDURES_SECTION.DELETE_CONFIRM' | translate:{
        title: (procAEliminar && procAEliminar.titulo) || '(Sense t√≠tol)'
      } }}
    </p>

    <div class="popup-actions">
      <button class="cancelar-btn" (click)="cancelarEliminar()" title="Cancelar">
        ‚úó
      </button>
      <button class="guardar-btn" (click)="eliminarProcedimiento()" title="Eliminar">
        ‚úì
      </button>
    </div>
  </div>
</div>

<!-- Popup veure steps -->
<div class="popup-fons" *ngIf="mostrarSteps" (click)="tancarSteps()">
  <div class="popup-container" (click)="$event.stopPropagation()">
    <h3>
      {{ 'PROCEDURES_SECTION.STEPS_TITLE' | translate }}:
      {{ procSeleccionada?.titulo }}
    </h3>

    <div *ngIf="!procSeleccionada?.steps?.length">
      {{ 'PROCEDURES_SECTION.NO_STEPS' | translate }}
    </div>

    <div *ngFor="let step of procSeleccionada?.steps; let i = index" class="step-item">
      <strong>Step {{ i + 1 }}: {{ step.titulo }}</strong><br>
      {{ 'PROCEDURES_SECTION.RESPONSIBLE' | translate }}: {{ step.responsable }}<br>
      {{ step.descripcion }}
    </div>

    <div class="popup-actions">
      <button class="cancelar-btn" (click)="tancarSteps()" title="Tancar">
        ‚úó
      </button>
    </div>
  </div>
</div>
